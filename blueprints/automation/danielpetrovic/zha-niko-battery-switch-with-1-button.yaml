blueprint:
  name: ZHA - Niko Battery switch with 1 button (552-720X1)
  author: danielpetrovic
  source_url: https://github.com/danielpetrovic/home-assistant-config/blob/main/blueprints/automation/danielpetrovic/zha-niko-battery-switch-with-1-button.yaml
  description: |
    # ZHA - Niko Battery switch with 1 button (552-720X1)

    This blueprint enables comprehensive control of a Niko Battery switch (model 552-720X1) through ZHA integration, supporting both custom actions and light automation.

    ## Key Features
    - **Custom Mode:** Program the button to execute your personalized home automation routines, from controlling your shades to activating security modes.
    - **Lights Mode:** Dim, brighten, and change the color of your lights depending on day and time of day with the intuitive button and a schedule.
    - **Auto-Adjust:** Optionally enable automatic light adjustment when your schedule changes - lights will smoothly transition to match the current schedule settings.

    *Each configuration option below includes detailed instructions in the automation editor.*

    ## Button Functions
    - **Short Press On/Off:** The button alternates between On and Off commands
    - **Long Press:** Built-in dimming functionality (increase/decrease brightness)
    - **Double Press:** Custom command (not built into the switch, implemented by blueprint)

    ## Schedule Helper Configuration

    Create time-based brightness and color adjustments using Home Assistant schedule helpers.

    ### Setting up Packages (Optional)
    Organize schedules into packages for easier management. Create a `packages` folder in `/config/` and add to your configuration:

    ```yaml
    homeassistant:
      packages: !include_dir_named packages
    ```

    ### Schedule YAML Example
    Create `/config/packages/lights.yaml` with your schedules:

    ```yaml
    schedule:
      lights_bright:
        name: "Lights Bright"
        icon: mdi:lightbulb-auto
        monday:
          - from: "00:00:00"
            to: "09:00:00"
            data:
              brightness_pct: 30
              color_temp_kelvin: 3333
          - from: "09:00:00"
            to: "23:00:00"
            data:
              brightness_pct: 90
              color_temp_kelvin: 3333
          - from: "23:00:00"
            to: "24:00:00"
            data:
              brightness_pct: 30
              color_temp_kelvin: 3333
        # Repeat pattern for tuesday through sunday
    ```

    You can create multiple schedules with different brightness levels (e.g., `lights_bright` and `lights_dimmed`) for different scenarios.

    ## Schedule Flexibility

    **Optional Fields:** If a schedule lacks certain data fields (like `transition`), the blueprint reverts to default values configured in the automation. This allows selective override of specific parameters while maintaining other preset defaults.

    **Supported Schedule Attributes:**
    - `brightness_pct`: Brightness percentage (0-100)
    - `color_temp_kelvin`: Color temperature in Kelvin
    - `transition`: Optional transition time in seconds

    ## Auto-Adjust Feature

    When enabled, the blueprint automatically updates lights when the schedule changes (e.g., when moving from morning to afternoon time block):
    - Only affects lights that are currently ON
    - Configurable transition duration (default: 5 minutes)
    - Applies current schedule's brightness and color temperature
    - Can be enabled/disabled per automation

    ## Requirements
    - Home Assistant 2024.10.0 or later
    - ZHA integration
    - Niko Battery switch model 552-720X1
  domain: automation
  homeassistant:
    min_version: 2024.10.0
  input:
    remote:
      name: Remote Device (NIKO)
      selector:
        device:
          filter:
            - integration: zha
              manufacturer: NIKO NV
              model: Battery switch, 1 button
          multiple: false
    button_1_custom:
      name: Button 1 - Custom Actions
      icon: mdi:numeric-1-circle-outline
      collapsed: true
      input:
        button_1_on:
          name: Short Press On
          description: Action for short press in on state.
          default: []
          selector:
            action: {}
        button_1_off:
          name: Short Press Off
          description: Action for short press in off state.
          default: []
          selector:
            action: {}
        button_1_double_press:
          name: Double Press
          description: Action for double press detection.
          default: []
          selector:
            action: {}
        button_1_increase:
          name: Long Press Increase
          description: Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_1_decrease:
          name: Long Press Decrease
          description: Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_1_stop:
          name: Long Press Release
          description: Action for release after long press.
          default: []
          selector:
            action: {}
    button_1_light:
      name: Button 1 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_1_light:
          name: Lights
          default: []
          description: Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_1_light_schedule:
          name: Schedule
          default: []
          description: Optional schedule helper for time-based brightness and color adjustments. **Schedules can be reused between lights.**
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_1_light_brightness:
          name: Default Brightness
          default: 100
          description: Default brightness percentage (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_1_light_color:
          name: Default Color Temperature
          default: 3333
          description: Default color temperature in Kelvin (fallback when schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_1_light_transition:
          name: Default Transition
          default: 1
          description: Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_1_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
        button_1_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_on_reset_to_defaults:
          name: Reset to Schedule/Defaults on Short Press On
          default: true
          description: Apply schedule/default brightness and color when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_off_reset_to_defaults:
          name: Reset to Schedule/Defaults on Short Press Off
          default: true
          description: Apply schedule/default brightness and color when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_1_dimmer_reset_to_defaults:
          name: Reset to Schedule/Defaults on Long Press
          default: false
          description: Apply schedule/default color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
    button_1_auto_adjust:
      name: Button 1 - Auto-Adjust
      icon: mdi:auto-fix
      collapsed: true
      input:
        button_1_light_schedule_auto_adjust:
          name: Auto-Adjust on Schedule Change
          default: false
          description: Automatically update lights when schedule changes. Only affects currently on lights.
          selector:
            boolean:
        button_1_light_schedule_auto_adjust_transition:
          name: Auto-Adjust Transition
          default: 300
          description: Transition duration in seconds when auto-adjusting lights on schedule change.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
mode: single
variables:
  stop_flag: false
  button_1_light: !input button_1_light
  has_light_target: >-
    {{ button_1_light.entity_id | default([]) | length > 0
    or button_1_light.device_id | default([]) | length > 0
    or button_1_light.area_id | default([]) | length > 0 }}
triggers:
  - trigger: event
    event_type: zha_event
    event_data:
      device_id: !input remote
    id: button_event
  - trigger: state
    entity_id: !input button_1_light_schedule
    id: schedule_change
actions:
  - variables:
      button_1_light_schedule: !input button_1_light_schedule
      button_1_light_color: !input button_1_light_color
      button_1_light_brightness: !input button_1_light_brightness
      button_1_light_transition: !input button_1_light_transition
      button_1_light_dimming_speed: !input button_1_light_dimming_speed
      button_1_light_step_size: "{{ (button_1_light_dimming_speed * 2.5) | int }}"
      button_1_dimming_delay: "{{ [0.15, (0.5 / button_1_light_dimming_speed)] | max }}"
      button_1_light_count:
        "{% set calc = (255 / button_1_light_step_size) | abs |
        round(0, 'ceil') %} {{ [calc, 3] | max }}"
      button_1_on_light_mode: !input button_1_on_light_mode
      button_1_on_reset_to_defaults: !input button_1_on_reset_to_defaults
      button_1_off_light_mode: !input button_1_off_light_mode
      button_1_off_reset_to_defaults: !input button_1_off_reset_to_defaults
      button_1_dimmer_light_mode: !input button_1_dimmer_light_mode
      button_1_dimmer_reset_to_defaults: !input button_1_dimmer_reset_to_defaults
      button_1_color_temp_kelvin: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {{ state_attr(button_1_light_schedule, 'color_temp_kelvin') | default(button_1_light_color) }}
        {% else %}
          {{ button_1_light_color }}
        {% endif %}
      button_1_brightness_pct: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {{ state_attr(button_1_light_schedule, 'brightness_pct') | default(button_1_light_brightness) }}
        {% else %}
          {{ button_1_light_brightness }}
        {% endif %}
      button_1_transition: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {{ state_attr(button_1_light_schedule, 'transition') | default(button_1_light_transition, true) | float }}
        {% else %}
          {{ button_1_light_transition | float }}
        {% endif %}
      button_1_light_schedule_auto_adjust: !input button_1_light_schedule_auto_adjust
      button_1_light_schedule_auto_adjust_transition: !input button_1_light_schedule_auto_adjust_transition
      light_entities: >-
        {% set ns = namespace(entities=[]) %}
        {% if button_1_light.entity_id is defined and button_1_light.entity_id | length > 0 %}
          {% set ns.entities = button_1_light.entity_id %}
        {% elif button_1_light.device_id is defined and button_1_light.device_id | length > 0 %}
          {% for device in button_1_light.device_id %}
            {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
          {% endfor %}
        {% elif button_1_light.area_id is defined and button_1_light.area_id | length > 0 %}
          {% for area in button_1_light.area_id %}
            {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
          {% endfor %}
        {% endif %}
        {{ ns.entities }}
  - choose:
      - conditions:
          - "{{ trigger.id == 'schedule_change' }}"
          - "{{ button_1_light_schedule_auto_adjust }}"
          - "{{ has_light_target }}"
          - "{{ button_1_light_schedule not in [none, '', null] }}"
        sequence:
          - repeat:
              for_each: "{{ light_entities }}"
              sequence:
                - if:
                    - "{{ is_state(repeat.item, 'on') }}"
                  then:
                    - action: light.turn_on
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        brightness_pct: "{{ button_1_brightness_pct }}"
                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                        transition: "{{ button_1_light_schedule_auto_adjust_transition }}"
          - stop: Schedule auto-adjust completed
      - conditions:
          - "{{ trigger.event.data.command in ['move','move_with_on_off']
            and trigger.event.data.args[0] == 0 }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_increase
          - alias: Light Mode
            if:
              - "{{ 'dim' in button_1_dimmer_light_mode and has_light_target }}"
            then:
              - parallel:
                  - sequence:
                      - wait_for_trigger:
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: stop
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: "on"
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: "off"
                        timeout: "30"
                        continue_on_timeout: true
                      - variables:
                          stop_flag: true
                  - sequence:
                      - repeat:
                          count: "{{ button_1_light_count }}"
                          sequence:
                            - choose:
                                - conditions:
                                    - "{{ button_1_dimmer_reset_to_defaults }}"
                                  sequence:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ button_1_light_step_size }}"
                                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                              default:
                                - action: light.turn_on
                                  target: "{{ button_1_light }}"
                                  data:
                                    brightness_step: "{{ button_1_light_step_size }}"
                            - delay:
                                seconds: "{{ button_1_dimming_delay }}"
                            - if:
                                - "{{ stop_flag }}"
                              then:
                                - stop: Stop flag set
              - stop: Done increase brightness
      - conditions:
          - "{{ trigger.event.data.command == 'move' and trigger.event.data.args[0]
            == 1 }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_decrease
          - alias: Light Mode
            if:
              - "{{ 'dim' in button_1_dimmer_light_mode and has_light_target }}"
            then:
              - parallel:
                  - sequence:
                      - wait_for_trigger:
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: stop
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: "on"
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input remote
                              command: "off"
                        timeout: "30"
                        continue_on_timeout: true
                      - variables:
                          stop_flag: true
                  - sequence:
                      - repeat:
                          count: "{{ button_1_light_count }}"
                          sequence:
                            - choose:
                                - conditions:
                                    - "{{ button_1_dimmer_reset_to_defaults }}"
                                  sequence:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_1_light_step_size }}"
                                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                              default:
                                - action: light.turn_on
                                  target: "{{ button_1_light }}"
                                  data:
                                    brightness_step: "{{ 0 - button_1_light_step_size }}"
                            - delay:
                                seconds: "{{ button_1_dimming_delay }}"
                            - if:
                                - "{{ stop_flag }}"
                              then:
                                - stop: Stop flag set
              - stop: Done decrease brightness
      - conditions:
          - "{{ trigger.event.data.command == 'stop' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_stop
  - variables:
      first_cmd: "{{ trigger.event.data.command }}"
  - condition: "{{ first_cmd in ['on','off'] }}"
  - wait_for_trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_id: !input remote
    timeout: "0.30"
    continue_on_timeout: true
  - if:
      - "{{ wait.trigger is not none and wait.trigger.event.data.command
        in ['on','off'] and wait.trigger.event.data.command != first_cmd }}"
    then:
      - sequence: !input button_1_double_press
      - stop: Double Press detected
  - choose:
      - conditions:
          - "{{ first_cmd == 'on' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_on
          - alias: Light Mode
            if:
              - "{{ has_light_target }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
      - conditions:
          - "{{ first_cmd == 'off' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_off
          - alias: Light Mode
            if:
              - "{{ has_light_target }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
