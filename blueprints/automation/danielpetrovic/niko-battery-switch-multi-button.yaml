blueprint:
  name: Niko Battery Switch (1/2/4 Buttons) (Z2M / ZHA)
  author: danielpetrovic
  source_url: https://github.com/danielpetrovic/home-assistant-config/blob/main/blueprints/automation/danielpetrovic/niko-battery-switch-multi-button.yaml
  description: |
    # Niko Battery Switch (1/2/4 Buttons) (Z2M / ZHA)

    [![GitHub](https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=github&logoColor=white)](https://github.com/danielpetrovic/home-assistant-config) [![Code](https://img.shields.io/badge/Code-2ea44f?style=for-the-badge&logo=homeassistant&logoColor=white)](https://github.com/danielpetrovic/home-assistant-config/blob/main/blueprints/automation/danielpetrovic/niko-battery-switch-multi-button.yaml) ![Version](https://img.shields.io/badge/Version-2026.01.13-blue?style=for-the-badge)

    This blueprint enables comprehensive control of Niko Battery switches (models 552-720X1, 552-720X2, 552-720X4) through Zigbee2MQTT or ZHA integration, supporting both custom actions and light automation.

    ## üì± Supported Models
    - **552-720X1**: Battery switch with 1 button
    - **552-720X2**: Battery switch with 2 buttons (Left, Right)
    - **552-720X4**: Battery switch with 4 buttons (Top Left, Bottom Left, Top Right, Bottom Right)

    ## ‚ú® Key Features
    - **Multiple Integration Options**: Choose Zigbee2MQTT (Z2M), ZHA, or both
    - **Custom Mode:** Program the buttons to execute your personalized home automation routines, from controlling your shades to activating security modes.
    - **Lights Mode:** Dim, brighten, and change the color of your lights depending on day and time of day with the intuitive buttons and a schedule.
    - **Adaptive Lighting Support:** Integrates with Home Assistant schedule helpers and adaptive lighting sensors for dynamic brightness and color temperature adjustments throughout the day.
    - **Auto-Adjust:** Optionally enable automatic light adjustment when your schedule changes - lights will smoothly transition to match the current schedule settings.

    *Each configuration option below includes detailed instructions in the automation editor.*

    ## üéõÔ∏è Button Mapping

    - **1-Button (552-720X1)**
      - Button 1: The single button

    - **2-Button (552-720X2)**
      - Button 1: Left button
      - Button 2: Right button

    - **4-Button (552-720X4)**
      - Button 1: Top Left button
      - Button 2: Bottom Left button
      - Button 3: Top Right button
      - Button 4: Bottom Right button

    ## ‚öôÔ∏è Button Functions
    - **Short Press On/Off:** Each button alternates between On and Off commands
    - **Long Press:** Built-in dimming functionality (increase/decrease brightness)
    - **Double Press:** Custom command (not built into the switch, implemented by blueprint)

    ## üìã Requirements

    - **Home Assistant**: Version 2024.10.0 or later
    - **Zigbee Integration**: Zigbee2MQTT (Z2M) and/or Zigbee Home Automation (ZHA)
    - **Compatible Models**: 552-720X1, 552-720X2, or 552-720X4
  domain: automation
  homeassistant:
    min_version: 2024.10.0
  input:
    version_info:
      name: Version History
      description: |
        - **2026.01.13: Complete direct mapping for all handlers**
          - Fixed: ZHA dimming now handles both 'move' and 'move_with_on_off' commands
          - Fixed: On/off handlers converted to direct mapping (removes whitespace issues)
          - Fixed: Double-click variables use single-line templates (no multiline whitespace)
          - Fixed: Z2M double-click reliability improved by removing unreliable elapsed payload check
          - Changed: Double-click timeout increased from 300ms to 500ms for better MQTT latency tolerance
          - Removed: Z2M elapsed field requirement (no longer needed in Z2M settings)

        - **2026.01.12: Direct mapping - eliminate normalization layer**
          - Changed: Replaced normalization-based routing with direct ZHA/Z2M conditions per handler
          - Fixed: Multi-button Z2M dimming and double-click now work correctly
          - Improved: Each handler explicitly lists supported ZHA endpoints and Z2M actions
          - Improved: No intermediate variables means no whitespace comparison issues
          - Removed: normalized_endpoint, normalized_command, normalized_move_mode, command, button_num, button_action variables

        - **2026.01.11: Normalize Z2M to ZHA format for unified handling**
          - Changed: Z2M actions now normalized to ZHA format (endpoint + command + move_mode)
          - Improved: Single unified command mapping handles both ZHA and Z2M identically
          - Improved: Eliminates complex 60-line device-model-specific action mapping
          - Improved: Z2M suffix checking uses most-specific-first logic to prevent overlap
          - Removed: Useless `value_json.brightness is not defined` filters (Z2M never sends this field)
          - Note: This is a major code simplification - easier to verify and maintain

        - **2026.01.9: Fix double-press detection, remove helpers, and remove adaptive lighting triggers**
          - **BREAKING:** Removed text helper requirement - delete the helper you created for v2026.01.8
          - **BREAKING:** Removed adaptive lighting auto-adjust triggers - adaptive brightness/color adjustments should be handled by the adaptive-lighting blueprint
          - Fixed: ZHA double-press detection - removed command filter from wait_for_trigger to allow ZHA events on event bus to be caught during mode: single blocking
          - Fixed: Z2M double-press detection - added elapsed field validation from MQTT payload to ensure events are within 300ms window
          - Fixed: Duplicate instance execution - changed automation mode from queued to single with max_exceeded: silent
          - Added: Z2M elapsed field validation using MQTT payload's elapsed field (lines 2796-2799)
          - Added: ZHA elapsed_ms calculation using trigger.event.time_fired (lines 2793-2798)
          - Added: Silent max exceeded handling to prevent error logs when buttons pressed too frequently
          - Improved: Schedule-based auto-adjust preserved - automatically updates lights when schedule helper values change (unique to this blueprint)
          - Improved: Universal double-press support for all 4 buttons on both ZHA and Z2M using event bus architecture without external helpers

        - **2026.01.8: Fix random dimming stops and improve trace debugging**
          - **BREAKING:** Added required input_text helper for double-click guard (see Helper Configuration section)
          - Fixed: Random dimming stops when holding multiple buttons simultaneously
          - Fixed: Double-click mistriggers - second press no longer also executes as single press
          - Changed: Replaced global stop_flag with button-specific flags (button_1_stop_flag through button_4_stop_flag)
          - Changed: Implemented helper-based guard to allow multi-button usage while preventing double-execution
          - Changed: Double-press timeout now automatic based on integration (ZHA: 300ms, Z2M: 600ms) - removed manual configuration
          - Improved: Each button's dimming operation now isolated from other buttons in queued mode
          - Improved: Multiple buttons can now be pressed in rapid succession without blocking (likely fixes 4-button issues)
          - Improved: Refactored on/off handlers from nested structure (4 options) to flat structure (8 separate options)
          - Improved: Traces now show explicitly "Button 1 on" vs "Button 1 off" instead of generic "Button 1 on/off"
          - Improved: Added descriptive aliases throughout for easier trace debugging (variable assignments, conditions, button handlers)

        - **2026.01.7: Increase double-click timeout default for Z2M compatibility**
          - Changed: Default timeout increased from 300ms to 500ms
          - Improved: Better compatibility with Z2M's MQTT protocol latency (50-200ms vs ZHA's 10-50ms direct event latency)
          - Note: Z2M users with slower button presses may still need 700-1000ms in automation settings

        - **2026.01.6: Fix double-click detection and prevent MQTT mistriggers**
          - Fixed: Added MQTT value_template filter to wait_for_trigger to prevent spurious triggers from battery/linkquality updates
          - Fixed: Refactored second trigger parsing to directly extract action and button number with explicit matching
          - Improved: Eliminated startswith/endswith on raw MQTT data, using explicit action lists instead
          - Improved: Cleaner variable naming (removed unnecessary intermediate second_command variable)

        - **2026.01.5: Fix Z2M double-click detection and button 4 dimming**
          - Fixed: Z2M double-click detection now works for buttons 2, 3, and 4
          - Fixed: Button 4 dimming now works on Z2M (was completely non-functional)
          - Fixed: second_button parsing logic now checks button-specific suffixes before generic prefixes
          - Fixed: MQTT trigger now filters for action messages only (prevents spurious triggers on battery/linkquality updates)
          - Improved: Correct identification of compound action names like on_bottom_right, off_bottom_right across all device types (1/2/4-button models)

        - **2026.01.4: Fix continuous dimming and Z2M support**
          - Fixed: ZHA continuous dimming now works properly (was stopping after one step)
          - Fixed: Z2M dimming now functional with proper MQTT payload filtering
          - Fixed: Removed unfiltered MQTT triggers that caught random messages (battery, linkquality)
          - Fixed: stop_flag now only sets when actual stop command received (not on timeout)
          - Improved: Cleaner trigger filtering - single ZHA event + filtered MQTT per button

        - **2026.01.3: Fix ZHA dimming and command parsing**
          - Fixed: ZHA dimming/brightening not working due to variable scope issue in command parsing
          - Improved: Command parsing now accesses trigger data directly instead of pre-extracted variables
          - Changed: Using cleaner `params.move_mode` instead of `args[0]` for ZHA brightness commands
          - Removed: Unused `zha_command`, `zha_endpoint`, `zha_args`, and `z2m_action` variables

        - **2026.01.2: Button-First Architecture (Major Refactor)**
          - Fixed: Complete restructuring to button-first architecture preventing NoneType errors
          - Fixed: Variables now load only when their specific button is used
          - Improved: Cleaner organization with 20 button-specific handlers
          - Enhanced: Support for 1, 2, and 4-button models without configuration conflicts

        - **2026.01.1: Fix critical multi-button light control and Z2M subscription issues**
          - Fixed: Multi-button light control handlers
          - Fixed: Z2M MQTT subscription errors

        - **2025.12.7: Fix critical bugs and add enhancements**
          - Various bug fixes and improvements

        - **2025.12.6: Fix critical bugs for multi button implementation**
          - Critical bug fixes for multi-button support

        - **2025.12.5: Add multi-button support for Niko battery switches**
          - Initial multi-button (1/2/4 button) support added

        - **2025.12.4: Add adaptive lighting support**
          - Adaptive lighting integration

        - **2025.12.3: Fix naming consistency**
          - Naming improvements

        - **2025.12.2: Add Zigbee2MQTT support and rename blueprint**
          - Z2M support added

        - **2025.12.1: Add configurable dimming speed and reorganize documentation**
          - Configurable dimming speed
          - Documentation improvements

        - **2025.08.1: Initial Version**
          - First release
      collapsed: true
      icon: mdi:history
      input: {}
    device_model:
      name: Device Model
      description: |
        `required`

        Select your Niko switch model. This determines how many button sections are available.
      default: "1_button"
      selector:
        select:
          options:
            - label: "1 Button (552-720X1)"
              value: "1_button"
            - label: "2 Buttons (552-720X2)"
              value: "2_button"
            - label: "4 Buttons (552-720X4)"
              value: "4_button"
          multiple: false
    integration_type:
      name: Integration Type
      description: |
        `required`

        Select which integration(s) to use for the Niko switch. You can select Z2M, ZHA, or both.
      default: []
      selector:
        select:
          options:
            - label: Zigbee2MQTT (Z2M)
              value: z2m
            - label: Zigbee Home Automation (ZHA)
              value: zha
          multiple: true
    z2m:
      name: Zigbee2MQTT (Z2M)
      description: |
        Configure Zigbee2MQTT integration settings.

        ‚ö†Ô∏è **Important:** Do NOT enable Z2M Simulated Brightness for Niko switches.

        Leave `simulated_brightness_delta` and `simulated_brightness_interval` **EMPTY** in Z2M device settings. If already configured, you must remove and re-pair the device. The blueprint provides optimized dimming.
      icon: mdi:zigbee
      collapsed: true
      input:
        z2m_base_topic:
          name: Base Topic
          description: |
            `optional` `text`

            MQTT base topic for Zigbee2MQTT installation (usually `zigbee2mqtt`). Leave empty if not using Z2M.
          default: ""
          selector:
            text: {}
        z2m_device_name:
          name: Device Friendly Name
          description: |
            `optional` `text`

            Friendly name of your Niko switch in Z2M (case-sensitive, as shown in Z2M UI). Leave empty if not using Z2M.
          default: ""
          selector:
            text: {}
    zha:
      name: Zigbee Home Automation (ZHA)
      description: Configure ZHA integration settings.
      icon: mdi:zigbee
      collapsed: true
      input:
        zha_remote:
          name: Remote Device (ZHA)
          description: |
            `optional` `device`

            Select the Niko switch device from ZHA. Leave empty if not using ZHA.
          default: {}
          selector:
            device:
              filter:
                - integration: zha
                  manufacturer: NIKO NV
              multiple: false
    schedule_helper_info:
      name: Schedule Helper Configuration
      description: |
        Create time-based brightness and color adjustments using Home Assistant schedule helpers.

        ### Setting up Packages (Optional)
        Organize schedules into packages for easier management. Create a `packages` folder in `/config/` and add to your configuration:

        ```yaml
        homeassistant:
          packages: !include_dir_named packages
        ```

        ### Schedule YAML Example
        Create `/config/packages/lights.yaml` with your schedules:

        ```yaml
        schedule:
          lights_bright:
            name: "Lights Bright"
            icon: mdi:lightbulb-auto
            monday:
              - from: "00:00:00"
                to: "09:00:00"
                data:
                  brightness_pct: 30
                  color_temp_kelvin: 3333
              - from: "09:00:00"
                to: "23:00:00"
                data:
                  brightness_pct: 90
                  color_temp_kelvin: 3333
              - from: "23:00:00"
                to: "24:00:00"
                data:
                  brightness_pct: 30
                  color_temp_kelvin: 3333
            # Repeat pattern for tuesday through sunday
        ```

        You can create multiple schedules with different brightness levels (e.g., `lights_bright` and `lights_dimmed`) for different scenarios.

        ### Schedule Flexibility

        **Optional Fields:** If a schedule lacks certain data fields (like `transition`), the blueprint reverts to default values configured in the automation. This allows selective override of specific parameters while maintaining other preset defaults.

        **Supported Schedule Attributes:**
        - `brightness_pct`: Brightness percentage (0-100)
        - `color_temp_kelvin`: Color temperature in Kelvin
        - `transition`: Optional transition time in seconds

        ### Auto-Adjust Feature

        When enabled, the blueprint automatically updates lights when the schedule changes (e.g., when moving from morning to afternoon time block):
        - Only affects lights that are currently ON
        - Configurable transition duration (default: 5 minutes)
        - Applies current schedule's brightness and color temperature
        - Can be enabled/disabled per automation
      collapsed: true
      icon: mdi:calendar-clock
      input: {}
    button_1_custom:
      name: Button 1 - Custom Actions
      icon: mdi:numeric-1-circle-outline
      collapsed: true
      input:
        button_1_on:
          name: Short Press On
          description: |
            `optional` `action`

            Action for short press in on state.
          default: []
          selector:
            action: {}
        button_1_off:
          name: Short Press Off
          description: |
            `optional` `action`

            Action for short press in off state.
          default: []
          selector:
            action: {}
        button_1_double_press:
          name: Double Press
          description: |
            `optional` `action`

            Action for double press detection.
          default: []
          selector:
            action: {}
        button_1_increase:
          name: Long Press Increase
          description: |
            `optional` `action`

            Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_1_decrease:
          name: Long Press Decrease
          description: |
            `optional` `action`

            Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_1_stop:
          name: Long Press Release
          description: |
            `optional` `action`

            Action for release after long press.
          default: []
          selector:
            action: {}
    button_1_light:
      name: Button 1 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_1_light:
          name: Lights
          default: []
          description: |
            `optional` `target`

            Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_1_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: |
            `optional` `select`

            Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: |
            `optional` `select`

            Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: |
            `optional` `select`

            Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_1_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: |
            `optional` `number`

            Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
    button_1_light_settings:
      name: Button 1 - Light Mode Settings
      icon: mdi:cog
      collapsed: true
      input:
        button_1_light_adjustment_mode:
          name: Light Adjustment Mode
          default: static
          description: |
            `optional` `select`

            Choose where brightness and color temperature values come from:
            - **Static**: Use the default values configured below
            - **Adaptive**: Use input_number helpers updated by the Adaptive Lighting Scheduler blueprint
            - **Schedule**: Use a schedule entity for time-based adjustments
          selector:
            select:
              options:
                - label: "Static"
                  value: static
                - label: "Adaptive"
                  value: adaptive
                - label: "Schedule"
                  value: schedule
              multiple: false
        button_1_light_brightness:
          name: Default Brightness
          default: 100
          description: |
            `optional` `number`

            Default brightness percentage (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_1_light_color:
          name: Default Color Temperature
          default: 3333
          description: |
            `optional` `color_temp`

            Default color temperature in Kelvin (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_1_light_transition:
          name: Default Transition
          default: 1
          description: |
            `optional` `number`

            Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_1_light_adaptive_brightness:
          name: Adaptive Brightness Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive brightness (0-100). Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_1_light_adaptive_color_temp:
          name: Adaptive Color Temperature Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive color temperature in Kelvin. Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_1_light_schedule:
          name: Schedule Helper
          default: []
          description: |
            `optional` `entity`

            Schedule helper for time-based brightness and color adjustments. Only used when Value Source is "Schedule".
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_1_light_auto_adjust:
          name: Schedule Helper - Auto Adjust
          default: false
          description: |
            `optional` `boolean`

            Automatically update lights when schedule values change. Only affects currently on lights.
          selector:
            boolean:
        button_1_light_auto_adjust_transition:
          name: Schedule Helper - Auto Adjust Transition
          default: 300
          description: |
            `optional` `number`

            Transition duration in seconds when auto-adjusting lights.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
        button_1_on_reset_to_defaults:
          name: Reset to Defaults on Short Press On
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_off_reset_to_defaults:
          name: Reset to Defaults on Short Press Off
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_dimmer_reset_to_defaults:
          name: Reset to Defaults on Long Press
          default: false
          description: |
            `optional` `boolean`

            Apply color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
    button_2_custom:
      name: Button 2 - Custom Actions
      icon: mdi:numeric-2-circle-outline
      collapsed: true
      input:
        button_2_on:
          name: Short Press On
          description: |
            `optional` `action`

            Action for short press in on state.
          default: []
          selector:
            action: {}
        button_2_off:
          name: Short Press Off
          description: |
            `optional` `action`

            Action for short press in off state.
          default: []
          selector:
            action: {}
        button_2_double_press:
          name: Double Press
          description: |
            `optional` `action`

            Action for double press detection.
          default: []
          selector:
            action: {}
        button_2_increase:
          name: Long Press Increase
          description: |
            `optional` `action`

            Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_2_decrease:
          name: Long Press Decrease
          description: |
            `optional` `action`

            Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_2_stop:
          name: Long Press Release
          description: |
            `optional` `action`

            Action for release after long press.
          default: []
          selector:
            action: {}
    button_2_light:
      name: Button 2 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_2_light:
          name: Lights
          default: []
          description: |
            `optional` `target`

            Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_2_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: |
            `optional` `select`

            Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_2_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: |
            `optional` `select`

            Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_2_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: |
            `optional` `select`

            Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_2_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: |
            `optional` `number`

            Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
    button_2_light_settings:
      name: Button 2 - Light Mode Settings
      icon: mdi:cog
      collapsed: true
      input:
        button_2_light_adjustment_mode:
          name: Light Adjustment Mode
          default: static
          description: |
            `optional` `select`

            Choose where brightness and color temperature values come from:
            - **Static**: Use the default values configured below
            - **Adaptive**: Use input_number helpers updated by the Adaptive Lighting Scheduler blueprint
            - **Schedule**: Use a schedule entity for time-based adjustments
          selector:
            select:
              options:
                - label: "Static"
                  value: static
                - label: "Adaptive"
                  value: adaptive
                - label: "Schedule"
                  value: schedule
              multiple: false
        button_2_light_brightness:
          name: Default Brightness
          default: 100
          description: |
            `optional` `number`

            Default brightness percentage (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_2_light_color:
          name: Default Color Temperature
          default: 3333
          description: |
            `optional` `color_temp`

            Default color temperature in Kelvin (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_2_light_transition:
          name: Default Transition
          default: 1
          description: |
            `optional` `number`

            Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_2_light_adaptive_brightness:
          name: Adaptive Brightness Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive brightness (0-100). Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_2_light_adaptive_color_temp:
          name: Adaptive Color Temperature Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive color temperature in Kelvin. Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_2_light_schedule:
          name: Schedule Helper
          default: []
          description: |
            `optional` `entity`

            Schedule helper for time-based brightness and color adjustments. Only used when Value Source is "Schedule".
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_2_light_auto_adjust:
          name: Schedule Helper - Auto Adjust
          default: false
          description: |
            `optional` `boolean`

            Automatically update lights when schedule values change. Only affects currently on lights.
          selector:
            boolean:
        button_2_light_auto_adjust_transition:
          name: Schedule Helper - Auto Adjust Transition
          default: 300
          description: |
            `optional` `number`

            Transition duration in seconds when auto-adjusting lights.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
        button_2_on_reset_to_defaults:
          name: Reset to Defaults on Short Press On
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_2_off_reset_to_defaults:
          name: Reset to Defaults on Short Press Off
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_2_dimmer_reset_to_defaults:
          name: Reset to Defaults on Long Press
          default: false
          description: |
            `optional` `boolean`

            Apply color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
    button_3_custom:
      name: Button 3 - Custom Actions
      icon: mdi:numeric-3-circle-outline
      collapsed: true
      input:
        button_3_on:
          name: Short Press On
          description: |
            `optional` `action`

            Action for short press in on state.
          default: []
          selector:
            action: {}
        button_3_off:
          name: Short Press Off
          description: |
            `optional` `action`

            Action for short press in off state.
          default: []
          selector:
            action: {}
        button_3_double_press:
          name: Double Press
          description: |
            `optional` `action`

            Action for double press detection.
          default: []
          selector:
            action: {}
        button_3_increase:
          name: Long Press Increase
          description: |
            `optional` `action`

            Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_3_decrease:
          name: Long Press Decrease
          description: |
            `optional` `action`

            Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_3_stop:
          name: Long Press Release
          description: |
            `optional` `action`

            Action for release after long press.
          default: []
          selector:
            action: {}
    button_3_light:
      name: Button 3 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_3_light:
          name: Lights
          default: []
          description: |
            `optional` `target`

            Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_3_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: |
            `optional` `select`

            Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_3_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: |
            `optional` `select`

            Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_3_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: |
            `optional` `select`

            Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_3_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: |
            `optional` `number`

            Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
    button_3_light_settings:
      name: Button 3 - Light Mode Settings
      icon: mdi:cog
      collapsed: true
      input:
        button_3_light_adjustment_mode:
          name: Light Adjustment Mode
          default: static
          description: |
            `optional` `select`

            Choose where brightness and color temperature values come from:
            - **Static**: Use the default values configured below
            - **Adaptive**: Use input_number helpers updated by the Adaptive Lighting Scheduler blueprint
            - **Schedule**: Use a schedule entity for time-based adjustments
          selector:
            select:
              options:
                - label: "Static"
                  value: static
                - label: "Adaptive"
                  value: adaptive
                - label: "Schedule"
                  value: schedule
              multiple: false
        button_3_light_brightness:
          name: Default Brightness
          default: 100
          description: |
            `optional` `number`

            Default brightness percentage (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_3_light_color:
          name: Default Color Temperature
          default: 3333
          description: |
            `optional` `color_temp`

            Default color temperature in Kelvin (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_3_light_transition:
          name: Default Transition
          default: 1
          description: |
            `optional` `number`

            Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_3_light_adaptive_brightness:
          name: Adaptive Brightness Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive brightness (0-100). Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_3_light_adaptive_color_temp:
          name: Adaptive Color Temperature Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive color temperature in Kelvin. Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_3_light_schedule:
          name: Schedule Helper
          default: []
          description: |
            `optional` `entity`

            Schedule helper for time-based brightness and color adjustments. Only used when Value Source is "Schedule".
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_3_light_auto_adjust:
          name: Schedule Helper - Auto Adjust
          default: false
          description: |
            `optional` `boolean`

            Automatically update lights when schedule values change. Only affects currently on lights.
          selector:
            boolean:
        button_3_light_auto_adjust_transition:
          name: Schedule Helper - Auto Adjust Transition
          default: 300
          description: |
            `optional` `number`

            Transition duration for auto-adjusting brightness and color when schedule values change.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
        button_3_on_reset_to_defaults:
          name: Reset to Defaults on Short Press On
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_3_off_reset_to_defaults:
          name: Reset to Defaults on Short Press Off
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_3_dimmer_reset_to_defaults:
          name: Reset to Defaults on Long Press
          default: false
          description: |
            `optional` `boolean`

            Apply color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
    button_4_custom:
      name: Button 4 - Custom Actions
      icon: mdi:numeric-4-circle-outline
      collapsed: true
      input:
        button_4_on:
          name: Short Press On
          description: |
            `optional` `action`

            Action for short press in on state.
          default: []
          selector:
            action: {}
        button_4_off:
          name: Short Press Off
          description: |
            `optional` `action`

            Action for short press in off state.
          default: []
          selector:
            action: {}
        button_4_double_press:
          name: Double Press
          description: |
            `optional` `action`

            Action for double press detection.
          default: []
          selector:
            action: {}
        button_4_increase:
          name: Long Press Increase
          description: |
            `optional` `action`

            Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_4_decrease:
          name: Long Press Decrease
          description: |
            `optional` `action`

            Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_4_stop:
          name: Long Press Release
          description: |
            `optional` `action`

            Action for release after long press.
          default: []
          selector:
            action: {}
    button_4_light:
      name: Button 4 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_4_light:
          name: Lights
          default: []
          description: |
            `optional` `target`

            Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_4_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: |
            `optional` `select`

            Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_4_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: |
            `optional` `select`

            Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_4_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: |
            `optional` `select`

            Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_4_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: |
            `optional` `number`

            Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
    button_4_light_settings:
      name: Button 4 - Light Mode Settings
      icon: mdi:cog
      collapsed: true
      input:
        button_4_light_adjustment_mode:
          name: Light Adjustment Mode
          default: static
          description: |
            `optional` `select`

            Choose where brightness and color temperature values come from:
            - **Static**: Use the default values configured below
            - **Adaptive**: Use input_number helpers updated by the Adaptive Lighting Scheduler blueprint
            - **Schedule**: Use a schedule entity for time-based adjustments
          selector:
            select:
              options:
                - label: "Static"
                  value: static
                - label: "Adaptive"
                  value: adaptive
                - label: "Schedule"
                  value: schedule
              multiple: false
        button_4_light_brightness:
          name: Default Brightness
          default: 100
          description: |
            `optional` `number`

            Default brightness percentage (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_4_light_color:
          name: Default Color Temperature
          default: 3333
          description: |
            `optional` `color_temp`

            Default color temperature in Kelvin (fallback when adaptive/schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_4_light_transition:
          name: Default Transition
          default: 1
          description: |
            `optional` `number`

            Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_4_light_adaptive_brightness:
          name: Adaptive Brightness Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive brightness (0-100). Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_4_light_adaptive_color_temp:
          name: Adaptive Color Temperature Helper
          default: []
          description: |
            `optional` `entity`

            Input number helper containing adaptive color temperature in Kelvin. Only used when Value Source is "Adaptive".
          selector:
            entity:
              filter:
                - domain:
                    - input_number
              multiple: false
        button_4_light_schedule:
          name: Schedule Helper
          default: []
          description: |
            `optional` `entity`

            Schedule helper for time-based brightness and color adjustments. Only used when Value Source is "Schedule".
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_4_light_auto_adjust:
          name: Schedule Helper - Auto Adjust
          default: false
          description: |
            `optional` `boolean`

            Automatically update lights when schedule values change. Only affects currently on lights.
          selector:
            boolean:
        button_4_light_auto_adjust_transition:
          name: Schedule Helper - Auto Adjust Transition
          default: 300
          description: |
            `optional` `number`

            Transition duration for auto-adjusting brightness and color when schedule values change.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
        button_4_on_reset_to_defaults:
          name: Reset to Defaults on Short Press On
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_4_off_reset_to_defaults:
          name: Reset to Defaults on Short Press Off
          default: true
          description: |
            `optional` `boolean`

            Apply brightness and color values when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_4_dimmer_reset_to_defaults:
          name: Reset to Defaults on Long Press
          default: false
          description: |
            `optional` `boolean`

            Apply color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
mode: single
max_exceeded: silent
trigger_variables:
  integration_type: !input integration_type
  z2m_base_topic: !input z2m_base_topic
  z2m_device_name: !input z2m_device_name
  device_model: !input device_model
variables:
  button_1_stop_flag: false
  button_2_stop_flag: false
  button_3_stop_flag: false
  button_4_stop_flag: false
  integration_type: !input integration_type
  z2m_base_topic: !input z2m_base_topic
  z2m_device_name: !input z2m_device_name
  device_model: !input device_model
  button_1_light: !input button_1_light
  button_2_light: !input button_2_light
  button_3_light: !input button_3_light
  button_4_light: !input button_4_light
triggers:
  - trigger: event
    event_type: zha_event
    event_data:
      device_id: !input zha_remote
    alias: zha_button
    id: zha_button
  - trigger: mqtt
    topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
    value_template: "{{ value_json.action is defined }}"
    alias: z2m_button
    id: z2m_button
  - trigger: state
    entity_id: !input button_1_light_schedule
    id: schedule_change_1
  - trigger: state
    entity_id: !input button_2_light_schedule
    id: schedule_change_2
  - trigger: state
    entity_id: !input button_3_light_schedule
    id: schedule_change_3
  - trigger: state
    entity_id: !input button_4_light_schedule
    id: schedule_change_4
actions:
  - alias: "Parse trigger and set initial variables"
    variables:
      # Event age detection - calculate milliseconds since event was fired
      # Used to detect and reject stale events from queued automation instances
      event_age_ms: >-
        {% if trigger.id == 'zha_button' %}
          {{ (now() - trigger.event.time_fired).total_seconds() * 1000 }}
        {% else %}
          0
        {% endif %}
      # Simple helper - no normalization, handlers use direct conditions
      is_button_event: "{{ trigger.id in ['zha_button', 'z2m_button'] }}"
  - condition: >-
      {{ (trigger.id == 'zha_button' and 'zha' in integration_type) or
         (trigger.id == 'z2m_button' and 'z2m' in integration_type) or
         trigger.id.startswith('schedule_change') }}
    alias: "Check if valid trigger type (ZHA/Z2M/schedule)"
  - alias: "Handle auto-adjust and brightness triggers"
    choose:
      # ========== BUTTON 1 AUTO-ADJUST ==========
      - conditions:
          - "{{ trigger.id == 'schedule_change_1' }}"
        alias: "Button 1 auto-adjust"
        sequence:
          - variables:
              button_1_light_adjustment_mode: !input button_1_light_adjustment_mode
              button_1_light_auto_adjust: !input button_1_light_auto_adjust
              button_1_light_auto_adjust_transition: !input button_1_light_auto_adjust_transition
              button_1_light_schedule: !input button_1_light_schedule
              button_1_light_adaptive_brightness: !input button_1_light_adaptive_brightness
              button_1_light_adaptive_color_temp: !input button_1_light_adaptive_color_temp
              button_1_light_color: !input button_1_light_color
              button_1_light_brightness: !input button_1_light_brightness
              button_1_light_transition: !input button_1_light_transition
              button_1_has_light: >-
                {{ button_1_light.entity_id | default([]) | length > 0
                or button_1_light.device_id | default([]) | length > 0
                or button_1_light.area_id | default([]) | length > 0 }}
              button_1_color_temp_kelvin: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_color_temp) | int(button_1_light_color) }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_1_light_color }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_color }}
                {% endif %}
              button_1_brightness_pct: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_brightness) | int(button_1_light_brightness) }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_1_light_brightness }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_brightness }}
                {% endif %}
              button_1_light_entities: >-
                {% set ns = namespace(entities=[]) %}
                {% if button_1_light.entity_id is defined and button_1_light.entity_id | length > 0 %}
                  {% if button_1_light.entity_id is string %}
                    {% set ns.entities = [button_1_light.entity_id] %}
                  {% else %}
                    {% set ns.entities = button_1_light.entity_id %}
                  {% endif %}
                {% elif button_1_light.device_id is defined and button_1_light.device_id | length > 0 %}
                  {% set devices = [button_1_light.device_id] if button_1_light.device_id is string else button_1_light.device_id %}
                  {% for device in devices %}
                    {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% elif button_1_light.area_id is defined and button_1_light.area_id | length > 0 %}
                  {% set areas = [button_1_light.area_id] if button_1_light.area_id is string else button_1_light.area_id %}
                  {% for area in areas %}
                    {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% endif %}
                {{ ns.entities }}
          - if:
              - "{{ button_1_light_auto_adjust and button_1_has_light }}"
            then:
              - repeat:
                  for_each: "{{ button_1_light_entities }}"
                  sequence:
                    - if:
                        - "{{ is_state(repeat.item, 'on') }}"
                      then:
                        - action: light.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
                          data:
                            brightness_pct: "{{ button_1_brightness_pct }}"
                            color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                            transition: "{{ button_1_light_auto_adjust_transition }}"
          - stop: Button 1 auto-adjust completed
      # ========== BUTTON 2 AUTO-ADJUST ==========
      - conditions:
          - "{{ trigger.id == 'schedule_change_2' }}"
        alias: "Button 2 auto-adjust"
        sequence:
          - variables:
              button_2_light_adjustment_mode: !input button_2_light_adjustment_mode
              button_2_light_auto_adjust: !input button_2_light_auto_adjust
              button_2_light_auto_adjust_transition: !input button_2_light_auto_adjust_transition
              button_2_light_schedule: !input button_2_light_schedule
              button_2_light_adaptive_brightness: !input button_2_light_adaptive_brightness
              button_2_light_adaptive_color_temp: !input button_2_light_adaptive_color_temp
              button_2_light_color: !input button_2_light_color
              button_2_light_brightness: !input button_2_light_brightness
              button_2_light_transition: !input button_2_light_transition
              button_2_has_light: >-
                {{ button_2_light.entity_id | default([]) | length > 0
                or button_2_light.device_id | default([]) | length > 0
                or button_2_light.area_id | default([]) | length > 0 }}
              button_2_color_temp_kelvin: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_color_temp) | int(button_2_light_color) }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_2_light_color }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_color }}
                {% endif %}
              button_2_brightness_pct: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_brightness) | int(button_2_light_brightness) }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_2_light_brightness }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_brightness }}
                {% endif %}
              button_2_light_entities: >-
                {% set ns = namespace(entities=[]) %}
                {% if button_2_light.entity_id is defined and button_2_light.entity_id | length > 0 %}
                  {% if button_2_light.entity_id is string %}
                    {% set ns.entities = [button_2_light.entity_id] %}
                  {% else %}
                    {% set ns.entities = button_2_light.entity_id %}
                  {% endif %}
                {% elif button_2_light.device_id is defined and button_2_light.device_id | length > 0 %}
                  {% set devices = [button_2_light.device_id] if button_2_light.device_id is string else button_2_light.device_id %}
                  {% for device in devices %}
                    {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% elif button_2_light.area_id is defined and button_2_light.area_id | length > 0 %}
                  {% set areas = [button_2_light.area_id] if button_2_light.area_id is string else button_2_light.area_id %}
                  {% for area in areas %}
                    {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% endif %}
                {{ ns.entities }}
          - if:
              - "{{ button_2_light_auto_adjust and button_2_has_light }}"
            then:
              - repeat:
                  for_each: "{{ button_2_light_entities }}"
                  sequence:
                    - if:
                        - "{{ is_state(repeat.item, 'on') }}"
                      then:
                        - action: light.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
                          data:
                            brightness_pct: "{{ button_2_brightness_pct }}"
                            color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                            transition: "{{ button_2_light_auto_adjust_transition }}"
          - stop: Button 2 auto-adjust completed
      # ========== BUTTON 3 AUTO-ADJUST ==========
      - conditions:
          - "{{ trigger.id == 'schedule_change_3' }}"
        alias: "Button 3 auto-adjust"
        sequence:
          - variables:
              button_3_light_adjustment_mode: !input button_3_light_adjustment_mode
              button_3_light_auto_adjust: !input button_3_light_auto_adjust
              button_3_light_auto_adjust_transition: !input button_3_light_auto_adjust_transition
              button_3_light_schedule: !input button_3_light_schedule
              button_3_light_adaptive_brightness: !input button_3_light_adaptive_brightness
              button_3_light_adaptive_color_temp: !input button_3_light_adaptive_color_temp
              button_3_light_color: !input button_3_light_color
              button_3_light_brightness: !input button_3_light_brightness
              button_3_light_transition: !input button_3_light_transition
              button_3_has_light: >-
                {{ button_3_light.entity_id | default([]) | length > 0
                or button_3_light.device_id | default([]) | length > 0
                or button_3_light.area_id | default([]) | length > 0 }}
              button_3_color_temp_kelvin: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_color_temp) | int(button_3_light_color) }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_3_light_color }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_color }}
                {% endif %}
              button_3_brightness_pct: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_brightness) | int(button_3_light_brightness) }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_3_light_brightness }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_brightness }}
                {% endif %}
              button_3_light_entities: >-
                {% set ns = namespace(entities=[]) %}
                {% if button_3_light.entity_id is defined and button_3_light.entity_id | length > 0 %}
                  {% if button_3_light.entity_id is string %}
                    {% set ns.entities = [button_3_light.entity_id] %}
                  {% else %}
                    {% set ns.entities = button_3_light.entity_id %}
                  {% endif %}
                {% elif button_3_light.device_id is defined and button_3_light.device_id | length > 0 %}
                  {% set devices = [button_3_light.device_id] if button_3_light.device_id is string else button_3_light.device_id %}
                  {% for device in devices %}
                    {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% elif button_3_light.area_id is defined and button_3_light.area_id | length > 0 %}
                  {% set areas = [button_3_light.area_id] if button_3_light.area_id is string else button_3_light.area_id %}
                  {% for area in areas %}
                    {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% endif %}
                {{ ns.entities }}
          - if:
              - "{{ button_3_light_auto_adjust and button_3_has_light }}"
            then:
              - repeat:
                  for_each: "{{ button_3_light_entities }}"
                  sequence:
                    - if:
                        - "{{ is_state(repeat.item, 'on') }}"
                      then:
                        - action: light.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
                          data:
                            brightness_pct: "{{ button_3_brightness_pct }}"
                            color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                            transition: "{{ button_3_light_auto_adjust_transition }}"
          - stop: Button 3 auto-adjust completed
      # ========== BUTTON 4 AUTO-ADJUST ==========
      - conditions:
          - "{{ trigger.id == 'schedule_change_4' }}"
        alias: "Button 4 auto-adjust"
        sequence:
          - variables:
              button_4_light_adjustment_mode: !input button_4_light_adjustment_mode
              button_4_light_auto_adjust: !input button_4_light_auto_adjust
              button_4_light_auto_adjust_transition: !input button_4_light_auto_adjust_transition
              button_4_light_schedule: !input button_4_light_schedule
              button_4_light_adaptive_brightness: !input button_4_light_adaptive_brightness
              button_4_light_adaptive_color_temp: !input button_4_light_adaptive_color_temp
              button_4_light_color: !input button_4_light_color
              button_4_light_brightness: !input button_4_light_brightness
              button_4_light_transition: !input button_4_light_transition
              button_4_has_light: >-
                {{ button_4_light.entity_id | default([]) | length > 0
                or button_4_light.device_id | default([]) | length > 0
                or button_4_light.area_id | default([]) | length > 0 }}
              button_4_color_temp_kelvin: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_color_temp) | int(button_4_light_color) }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_4_light_color }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_color }}
                {% endif %}
              button_4_brightness_pct: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_brightness) | int(button_4_light_brightness) }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_4_light_brightness }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_brightness }}
                {% endif %}
              button_4_light_entities: >-
                {% set ns = namespace(entities=[]) %}
                {% if button_4_light.entity_id is defined and button_4_light.entity_id | length > 0 %}
                  {% if button_4_light.entity_id is string %}
                    {% set ns.entities = [button_4_light.entity_id] %}
                  {% else %}
                    {% set ns.entities = button_4_light.entity_id %}
                  {% endif %}
                {% elif button_4_light.device_id is defined and button_4_light.device_id | length > 0 %}
                  {% set devices = [button_4_light.device_id] if button_4_light.device_id is string else button_4_light.device_id %}
                  {% for device in devices %}
                    {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% elif button_4_light.area_id is defined and button_4_light.area_id | length > 0 %}
                  {% set areas = [button_4_light.area_id] if button_4_light.area_id is string else button_4_light.area_id %}
                  {% for area in areas %}
                    {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
                  {% endfor %}
                {% endif %}
                {{ ns.entities }}
          - if:
              - "{{ button_4_light_auto_adjust and button_4_has_light }}"
            then:
              - repeat:
                  for_each: "{{ button_4_light_entities }}"
                  sequence:
                    - if:
                        - "{{ is_state(repeat.item, 'on') }}"
                      then:
                        - action: light.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
                          data:
                            brightness_pct: "{{ button_4_brightness_pct }}"
                            color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                            transition: "{{ button_4_light_auto_adjust_transition }}"
          - stop: Button 4 auto-adjust completed
      # ========== BUTTON 1 BRIGHTNESS UP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 1 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 0 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_move_up', 'brightness_move_up_left', 'brightness_move_up_top_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_increase
          - variables:
              button_1_dimmer_light_mode: !input button_1_dimmer_light_mode
              button_1_has_light: >-
                {{ button_1_light.entity_id | default([]) | length > 0
                or button_1_light.device_id | default([]) | length > 0
                or button_1_light.area_id | default([]) | length > 0 }}
              button_1_light_dimming_speed: !input button_1_light_dimming_speed
              button_1_light_step_size: "{{ (button_1_light_dimming_speed | default(5) * 2.5) | int }}"
              button_1_dimming_delay: "{{ [0.15, (0.5 / (button_1_light_dimming_speed | default(5)))] | max }}"
              button_1_light_count: "{% set calc = (255 / button_1_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_1_dimmer_reset_to_defaults: !input button_1_dimmer_reset_to_defaults
              button_1_light_adjustment_mode: !input button_1_light_adjustment_mode
              button_1_light_schedule: !input button_1_light_schedule
              button_1_light_adaptive_color_temp: !input button_1_light_adaptive_color_temp
              button_1_light_color: !input button_1_light_color
              button_1_color_temp_kelvin: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_color_temp) | int(button_1_light_color) }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_1_light_color }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_1_dimmer_light_mode and button_1_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 1
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop', 'brightness_stop_left', 'brightness_stop_top_left'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_1_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_1_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_1_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_1_light }}"
                                          data:
                                            brightness_step: "{{ button_1_light_step_size }}"
                                            color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                            transition: "{{ button_1_dimming_delay }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ button_1_light_step_size }}"
                                        transition: "{{ button_1_dimming_delay }}"
                                - delay:
                                    seconds: "{{ button_1_dimming_delay }}"
                                - if:
                                    - "{{ button_1_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 2 BRIGHTNESS UP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 2 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 0 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_move_up_right', 'brightness_move_up_bottom_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_2_increase
          - variables:
              button_2_dimmer_light_mode: !input button_2_dimmer_light_mode
              button_2_has_light: >-
                {{ button_2_light.entity_id | default([]) | length > 0
                or button_2_light.device_id | default([]) | length > 0
                or button_2_light.area_id | default([]) | length > 0 }}
              button_2_light_dimming_speed: !input button_2_light_dimming_speed
              button_2_light_step_size: "{{ (button_2_light_dimming_speed | default(5) * 2.5) | int }}"
              button_2_dimming_delay: "{{ [0.15, (0.5 / (button_2_light_dimming_speed | default(5)))] | max }}"
              button_2_light_count: "{% set calc = (255 / button_2_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_2_dimmer_reset_to_defaults: !input button_2_dimmer_reset_to_defaults
              button_2_light_adjustment_mode: !input button_2_light_adjustment_mode
              button_2_light_schedule: !input button_2_light_schedule
              button_2_light_adaptive_color_temp: !input button_2_light_adaptive_color_temp
              button_2_light_color: !input button_2_light_color
              button_2_color_temp_kelvin: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_color_temp) | int(button_2_light_color) }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_2_light_color }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_2_dimmer_light_mode and button_2_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 2
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop_right', 'brightness_stop_bottom_left'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_2_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_2_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_2_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_2_light }}"
                                          data:
                                            brightness_step: "{{ button_2_light_step_size }}"
                                            color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                            transition: "{{ button_2_dimming_delay }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_2_light }}"
                                      data:
                                        brightness_step: "{{ button_2_light_step_size }}"
                                        transition: "{{ button_2_dimming_delay }}"
                                - delay:
                                    seconds: "{{ button_2_dimming_delay }}"
                                - if:
                                    - "{{ button_2_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 3 BRIGHTNESS UP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 3 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 0 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_move_up_top_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_3_increase
          - variables:
              button_3_dimmer_light_mode: !input button_3_dimmer_light_mode
              button_3_has_light: >-
                {{ button_3_light.entity_id | default([]) | length > 0
                or button_3_light.device_id | default([]) | length > 0
                or button_3_light.area_id | default([]) | length > 0 }}
              button_3_light_dimming_speed: !input button_3_light_dimming_speed
              button_3_light_step_size: "{{ (button_3_light_dimming_speed | default(5) * 2.5) | int }}"
              button_3_dimming_delay: "{{ [0.15, (0.5 / (button_3_light_dimming_speed | default(5)))] | max }}"
              button_3_light_count: "{% set calc = (255 / button_3_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_3_dimmer_reset_to_defaults: !input button_3_dimmer_reset_to_defaults
              button_3_light_adjustment_mode: !input button_3_light_adjustment_mode
              button_3_light_schedule: !input button_3_light_schedule
              button_3_light_adaptive_color_temp: !input button_3_light_adaptive_color_temp
              button_3_light_color: !input button_3_light_color
              button_3_color_temp_kelvin: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_color_temp) | int(button_3_light_color) }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_3_light_color }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_3_dimmer_light_mode and button_3_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 3
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop_top_right'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_3_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_3_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_3_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_3_light }}"
                                          data:
                                            brightness_step: "{{ button_3_light_step_size }}"
                                            color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                            transition: "{{ button_3_dimming_delay }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_3_light }}"
                                      data:
                                        brightness_step: "{{ button_3_light_step_size }}"
                                        transition: "{{ button_3_dimming_delay }}"
                                - delay:
                                    seconds: "{{ button_3_dimming_delay }}"
                                - if:
                                    - "{{ button_3_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 4 BRIGHTNESS UP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 4 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 0 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_move_up_bottom_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_4_increase
          - variables:
              button_4_dimmer_light_mode: !input button_4_dimmer_light_mode
              button_4_has_light: >-
                {{ button_4_light.entity_id | default([]) | length > 0
                or button_4_light.device_id | default([]) | length > 0
                or button_4_light.area_id | default([]) | length > 0 }}
              button_4_light_dimming_speed: !input button_4_light_dimming_speed
              button_4_light_step_size: "{{ (button_4_light_dimming_speed | default(5) * 2.5) | int }}"
              button_4_dimming_delay: "{{ [0.15, (0.5 / (button_4_light_dimming_speed | default(5)))] | max }}"
              button_4_light_count: "{% set calc = (255 / button_4_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_4_dimmer_reset_to_defaults: !input button_4_dimmer_reset_to_defaults
              button_4_light_adjustment_mode: !input button_4_light_adjustment_mode
              button_4_light_schedule: !input button_4_light_schedule
              button_4_light_adaptive_color_temp: !input button_4_light_adaptive_color_temp
              button_4_light_color: !input button_4_light_color
              button_4_color_temp_kelvin: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_color_temp) | int(button_4_light_color) }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_4_light_color }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_4_dimmer_light_mode and button_4_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 4
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop_bottom_right'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_4_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_4_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_4_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_4_light }}"
                                          data:
                                            brightness_step: "{{ button_4_light_step_size }}"
                                            color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                            transition: "{{ button_4_dimming_delay }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_4_light }}"
                                      data:
                                        brightness_step: "{{ button_4_light_step_size }}"
                                        transition: "{{ button_4_dimming_delay }}"
                                - delay:
                                    seconds: "{{ button_4_dimming_delay }}"
                                - if:
                                    - "{{ button_4_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 1 BRIGHTNESS DOWN ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 1 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 1 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_move_down', 'brightness_move_down_left', 'brightness_move_down_top_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_decrease
          - variables:
              button_1_dimmer_light_mode: !input button_1_dimmer_light_mode
              button_1_has_light: >-
                {{ button_1_light.entity_id | default([]) | length > 0
                or button_1_light.device_id | default([]) | length > 0
                or button_1_light.area_id | default([]) | length > 0 }}
              button_1_light_dimming_speed: !input button_1_light_dimming_speed
              button_1_light_step_size: "{{ (button_1_light_dimming_speed | default(5) * 2.5) | int }}"
              button_1_dimming_delay: "{{ [0.15, (0.5 / (button_1_light_dimming_speed | default(5)))] | max }}"
              button_1_light_count: "{% set calc = (255 / button_1_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_1_dimmer_reset_to_defaults: !input button_1_dimmer_reset_to_defaults
              button_1_light_adjustment_mode: !input button_1_light_adjustment_mode
              button_1_light_schedule: !input button_1_light_schedule
              button_1_light_adaptive_color_temp: !input button_1_light_adaptive_color_temp
              button_1_light_color: !input button_1_light_color
              button_1_color_temp_kelvin: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_color_temp) | int(button_1_light_color) }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_1_light_color }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_1_dimmer_light_mode and button_1_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 1
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop', 'brightness_stop_left', 'brightness_stop_top_left'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_1_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_1_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_1_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_1_light }}"
                                          data:
                                            brightness_step: "{{ 0 - button_1_light_step_size }}"
                                            color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_1_light_step_size }}"
                                - delay:
                                    seconds: "{{ button_1_dimming_delay }}"
                                - if:
                                    - "{{ button_1_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 2 BRIGHTNESS DOWN ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 2 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 1 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_move_down_right', 'brightness_move_down_bottom_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_2_decrease
          - variables:
              button_2_dimmer_light_mode: !input button_2_dimmer_light_mode
              button_2_has_light: >-
                {{ button_2_light.entity_id | default([]) | length > 0
                or button_2_light.device_id | default([]) | length > 0
                or button_2_light.area_id | default([]) | length > 0 }}
              button_2_light_dimming_speed: !input button_2_light_dimming_speed
              button_2_light_step_size: "{{ (button_2_light_dimming_speed | default(5) * 2.5) | int }}"
              button_2_dimming_delay: "{{ [0.15, (0.5 / (button_2_light_dimming_speed | default(5)))] | max }}"
              button_2_light_count: "{% set calc = (255 / button_2_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_2_dimmer_reset_to_defaults: !input button_2_dimmer_reset_to_defaults
              button_2_light_adjustment_mode: !input button_2_light_adjustment_mode
              button_2_light_schedule: !input button_2_light_schedule
              button_2_light_adaptive_color_temp: !input button_2_light_adaptive_color_temp
              button_2_light_color: !input button_2_light_color
              button_2_color_temp_kelvin: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_color_temp) | int(button_2_light_color) }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_2_light_color }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_2_dimmer_light_mode and button_2_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 2
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop_right', 'brightness_stop_bottom_left'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_2_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_2_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_2_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_2_light }}"
                                          data:
                                            brightness_step: "{{ 0 - button_2_light_step_size }}"
                                            color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_2_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_2_light_step_size }}"
                                - delay:
                                    seconds: "{{ button_2_dimming_delay }}"
                                - if:
                                    - "{{ button_2_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 3 BRIGHTNESS DOWN ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 3 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 1 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_move_down_top_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_3_decrease
          - variables:
              button_3_dimmer_light_mode: !input button_3_dimmer_light_mode
              button_3_has_light: >-
                {{ button_3_light.entity_id | default([]) | length > 0
                or button_3_light.device_id | default([]) | length > 0
                or button_3_light.area_id | default([]) | length > 0 }}
              button_3_light_dimming_speed: !input button_3_light_dimming_speed
              button_3_light_step_size: "{{ (button_3_light_dimming_speed | default(5) * 2.5) | int }}"
              button_3_dimming_delay: "{{ [0.15, (0.5 / (button_3_light_dimming_speed | default(5)))] | max }}"
              button_3_light_count: "{% set calc = (255 / button_3_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_3_dimmer_reset_to_defaults: !input button_3_dimmer_reset_to_defaults
              button_3_light_adjustment_mode: !input button_3_light_adjustment_mode
              button_3_light_schedule: !input button_3_light_schedule
              button_3_light_adaptive_color_temp: !input button_3_light_adaptive_color_temp
              button_3_light_color: !input button_3_light_color
              button_3_color_temp_kelvin: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_color_temp) | int(button_3_light_color) }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_3_light_color }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_3_dimmer_light_mode and button_3_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 3
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {% set action = value_json.action | default('') %}
                                  {{ action == 'brightness_stop_top_right' }}
                            timeout: "30"
                            continue_on_timeout: true
                      - if:
                          - "{{ wait.trigger is not none }}"
                        then:
                          - variables:
                              button_3_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_3_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_3_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_3_light }}"
                                          data:
                                            brightness_step: "{{ 0 - button_3_light_step_size }}"
                                            color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_3_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_3_light_step_size }}"
                                - delay:
                                    seconds: "{{ button_3_dimming_delay }}"
                                - if:
                                    - "{{ button_3_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 4 BRIGHTNESS DOWN ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 4 and trigger.event.data.command in ['move', 'move_with_on_off'] and trigger.event.data.params.move_mode == 1 }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_move_down_bottom_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_4_decrease
          - variables:
              button_4_dimmer_light_mode: !input button_4_dimmer_light_mode
              button_4_has_light: >-
                {{ button_4_light.entity_id | default([]) | length > 0
                or button_4_light.device_id | default([]) | length > 0
                or button_4_light.area_id | default([]) | length > 0 }}
              button_4_light_dimming_speed: !input button_4_light_dimming_speed
              button_4_light_step_size: "{{ (button_4_light_dimming_speed | default(5) * 2.5) | int }}"
              button_4_dimming_delay: "{{ [0.15, (0.5 / (button_4_light_dimming_speed | default(5)))] | max }}"
              button_4_light_count: "{% set calc = (255 / button_4_light_step_size) | abs | round(0, 'ceil') %} {{ [calc, 3] | max }}"
              button_4_dimmer_reset_to_defaults: !input button_4_dimmer_reset_to_defaults
              button_4_light_adjustment_mode: !input button_4_light_adjustment_mode
              button_4_light_schedule: !input button_4_light_schedule
              button_4_light_adaptive_color_temp: !input button_4_light_adaptive_color_temp
              button_4_light_color: !input button_4_light_color
              button_4_color_temp_kelvin: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_color_temp) | int(button_4_light_color) }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_4_light_color }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_color }}
                {% endif %}
          - if:
              - "{{ 'dim' in button_4_dimmer_light_mode and button_4_has_light }}"
            then:
              # Loop-based dimming with smooth transitions
              - parallel:
                      - sequence:
                          - wait_for_trigger:
                              - trigger: event
                                event_type: zha_event
                                event_data:
                                  device_id: !input zha_remote
                                  endpoint_id: 4
                                  command: stop
                              - trigger: mqtt
                                topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                                value_template: >-
                                  {{ value_json.action | default('') in ['brightness_stop_bottom_right'] }}
                            timeout: "30"
                            continue_on_timeout: true
                          - if:
                              - "{{ wait.trigger is not none }}"
                            then:
                              - variables:
                                  button_4_stop_flag: true
                      - sequence:
                          - repeat:
                              count: "{{ button_4_light_count }}"
                              sequence:
                                - choose:
                                    - conditions:
                                        - "{{ button_4_dimmer_reset_to_defaults }}"
                                      sequence:
                                        - action: light.turn_on
                                          target: "{{ button_4_light }}"
                                          data:
                                            brightness_step: "{{ 0 - button_4_light_step_size }}"
                                            color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                  default:
                                    - action: light.turn_on
                                      target: "{{ button_4_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_4_light_step_size }}"
                                - delay:
                                    seconds: "{{ button_4_dimming_delay }}"
                                - if:
                                    - "{{ button_4_stop_flag }}"
                                  then:
                                    - stop: Stop flag set
      # ========== BUTTON 1 BRIGHTNESS STOP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 1 and trigger.event.data.command == 'stop' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_stop', 'brightness_stop_left', 'brightness_stop_top_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_stop
      # ========== BUTTON 2 BRIGHTNESS STOP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 2 and trigger.event.data.command == 'stop' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['brightness_stop_right', 'brightness_stop_bottom_left'] }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_2_stop
      # ========== BUTTON 3 BRIGHTNESS STOP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 3 and trigger.event.data.command == 'stop' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_stop_top_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_3_stop
      # ========== BUTTON 4 BRIGHTNESS STOP ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 4 and trigger.event.data.command == 'stop' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'brightness_stop_bottom_right' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_4_stop
  - condition: "{{ is_button_event }}"
    alias: "Check if button event (not schedule/adaptive trigger)"
  - condition: >-
      {{ (trigger.id == 'zha_button' and trigger.event.data.command in ['on', 'off']) or
         (trigger.id == 'z2m_button' and (trigger.payload_json.action.startswith('on') or trigger.payload_json.action.startswith('off'))) }}
    alias: "Check if on/off action (not dimming)"
  - alias: "Store first press details"
    variables:
      first_button: "{{ trigger.event.data.endpoint_id | default(1) if trigger.id == 'zha_button' else (1 if trigger.payload_json.action in ['on', 'off', 'on_left', 'off_left', 'on_top_left', 'off_top_left'] else 2 if trigger.payload_json.action in ['on_right', 'off_right', 'on_bottom_left', 'off_bottom_left'] else 3 if trigger.payload_json.action in ['on_top_right', 'off_top_right'] else 4) }}"
      first_action: "{{ 'on' if (trigger.id == 'zha_button' and trigger.event.data.command == 'on') or (trigger.id == 'z2m_button' and trigger.payload_json.action.startswith('on')) else 'off' }}"
  - wait_for_trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_id: !input zha_remote
        alias: "ZHA second press"
      - trigger: mqtt
        topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
        value_template: >-
          {{ value_json.action is defined and
             value_json.action in ['on', 'off', 'on_left', 'off_left', 'on_right', 'off_right',
                                    'on_top_left', 'off_top_left', 'on_bottom_left', 'off_bottom_left',
                                    'on_top_right', 'off_top_right', 'on_bottom_right', 'off_bottom_right'] }}
        alias: "Z2M second press"
    timeout: 0.5
    continue_on_timeout: true
  - alias: "Parse second press details"
    variables:
      # Second action: 'on', 'off', or 'none' - single-line to avoid whitespace issues
      # ZHA: uses event.time_fired for elapsed check; Z2M: trusts wait_for_trigger timeout
      second_action: "{{ 'none' if wait.trigger is none else ('none' if wait.trigger.platform == 'event' and (now() - wait.trigger.event.time_fired).total_seconds() * 1000 > 500 else (wait.trigger.event.data.command if wait.trigger.platform == 'event' else ('on' if wait.trigger.payload_json.action | default('') in ['on', 'on_left', 'on_right', 'on_top_left', 'on_bottom_left', 'on_top_right', 'on_bottom_right'] else ('off' if wait.trigger.payload_json.action | default('') in ['off', 'off_left', 'off_right', 'off_top_left', 'off_bottom_left', 'off_top_right', 'off_bottom_right'] else 'none')))) }}"
      # Second button: 1-4 or 0 if none - single-line to avoid whitespace issues
      second_button: "{{ 0 if wait.trigger is none else (wait.trigger.event.data.endpoint_id | default(1) if wait.trigger.platform == 'event' else (1 if wait.trigger.payload_json.action | default('') in ['on', 'off', 'on_left', 'off_left', 'on_top_left', 'off_top_left'] else (2 if wait.trigger.payload_json.action | default('') in ['on_right', 'off_right', 'on_bottom_left', 'off_bottom_left'] else (3 if wait.trigger.payload_json.action | default('') in ['on_top_right', 'off_top_right'] else 4)))) }}"
  - if:
      - "{{ second_action in ['on', 'off'] and second_action != first_action and second_button == first_button }}"
    alias: "Validate double-click: opposite action on same button"
    then:
      - choose:
          - conditions:
              - "{{ first_button == 1 }}"
            alias: "Button 1 double-press"
            sequence:
              - sequence: !input button_1_double_press
          - conditions:
              - "{{ first_button == 2 }}"
            alias: "Button 2 double-press"
            sequence:
              - sequence: !input button_2_double_press
          - conditions:
              - "{{ first_button == 3 }}"
            alias: "Button 3 double-press"
            sequence:
              - sequence: !input button_3_double_press
          - conditions:
              - "{{ first_button == 4 }}"
            alias: "Button 4 double-press"
            sequence:
              - sequence: !input button_4_double_press
      - stop: Double Press detected
  # ========== BUTTON-SPECIFIC ON/OFF HANDLERS ==========
  - choose:
      # ========== BUTTON 1 ON ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 1 and trigger.event.data.command == 'on' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['on', 'on_left', 'on_top_left'] }}"
        alias: "Button 1 on"
        sequence:
          - alias: "Set button 1 configuration variables"
            variables:
              button_1_has_light: >-
                {{ button_1_light.entity_id | default([]) | length > 0
                or button_1_light.device_id | default([]) | length > 0
                or button_1_light.area_id | default([]) | length > 0 }}
              button_1_light_adjustment_mode: !input button_1_light_adjustment_mode
              button_1_light_adaptive_brightness: !input button_1_light_adaptive_brightness
              button_1_light_brightness: !input button_1_light_brightness
              button_1_light_schedule: !input button_1_light_schedule
              button_1_light_adaptive_color_temp: !input button_1_light_adaptive_color_temp
              button_1_light_color: !input button_1_light_color
              button_1_light_transition: !input button_1_light_transition
              button_1_on_light_mode: !input button_1_on_light_mode
              button_1_on_reset_to_defaults: !input button_1_on_reset_to_defaults
              button_1_color_temp_kelvin: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_color_temp) | int(button_1_light_color) }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_1_light_color }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_color }}
                {% endif %}
              button_1_brightness_pct: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_brightness) | int(button_1_light_brightness) }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_1_light_brightness }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_brightness }}
                {% endif %}
              button_1_transition: >-
                {% if button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_1_light_schedule, 'transition') | default(button_1_light_transition, true) | float }}
                  {% else %}
                    {{ button_1_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_1_on
          - alias: Light Mode
            if:
              - "{{ button_1_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
      # ========== BUTTON 1 OFF ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 1 and trigger.event.data.command == 'off' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['off', 'off_left', 'off_top_left'] }}"
        alias: "Button 1 off"
        sequence:
          - alias: "Set button 1 configuration variables"
            variables:
              button_1_has_light: >-
                {{ button_1_light.entity_id | default([]) | length > 0
                or button_1_light.device_id | default([]) | length > 0
                or button_1_light.area_id | default([]) | length > 0 }}
              button_1_light_adjustment_mode: !input button_1_light_adjustment_mode
              button_1_light_adaptive_brightness: !input button_1_light_adaptive_brightness
              button_1_light_brightness: !input button_1_light_brightness
              button_1_light_schedule: !input button_1_light_schedule
              button_1_light_adaptive_color_temp: !input button_1_light_adaptive_color_temp
              button_1_light_color: !input button_1_light_color
              button_1_light_transition: !input button_1_light_transition
              button_1_off_light_mode: !input button_1_off_light_mode
              button_1_off_reset_to_defaults: !input button_1_off_reset_to_defaults
              button_1_color_temp_kelvin: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_color_temp) | int(button_1_light_color) }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_1_light_color }}
                  {% else %}
                    {{ button_1_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_color }}
                {% endif %}
              button_1_brightness_pct: >-
                {% if button_1_light_adjustment_mode == 'adaptive' %}
                  {% if button_1_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_1_light_adaptive_brightness) | int(button_1_light_brightness) }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% elif button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_1_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_1_light_brightness }}
                  {% else %}
                    {{ button_1_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_brightness }}
                {% endif %}
              button_1_transition: >-
                {% if button_1_light_adjustment_mode == 'schedule' %}
                  {% if button_1_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_1_light_schedule, 'transition') | default(button_1_light_transition, true) | float }}
                  {% else %}
                    {{ button_1_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_1_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_1_off
          - alias: Light Mode
            if:
              - "{{ button_1_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
      # ========== BUTTON 2 ON ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 2 and trigger.event.data.command == 'on' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['on_right', 'on_bottom_left'] }}"
        alias: "Button 2 on"
        sequence:
          - alias: "Set button 2 configuration variables"
            variables:
              button_2_has_light: >-
                {{ button_2_light.entity_id | default([]) | length > 0
                or button_2_light.device_id | default([]) | length > 0
                or button_2_light.area_id | default([]) | length > 0 }}
              button_2_light_adjustment_mode: !input button_2_light_adjustment_mode
              button_2_light_adaptive_brightness: !input button_2_light_adaptive_brightness
              button_2_light_brightness: !input button_2_light_brightness
              button_2_light_schedule: !input button_2_light_schedule
              button_2_light_adaptive_color_temp: !input button_2_light_adaptive_color_temp
              button_2_light_color: !input button_2_light_color
              button_2_light_transition: !input button_2_light_transition
              button_2_on_light_mode: !input button_2_on_light_mode
              button_2_on_reset_to_defaults: !input button_2_on_reset_to_defaults
              button_2_color_temp_kelvin: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_color_temp) | int(button_2_light_color) }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_2_light_color }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_color }}
                {% endif %}
              button_2_brightness_pct: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_brightness) | int(button_2_light_brightness) }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_2_light_brightness }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_brightness }}
                {% endif %}
              button_2_transition: >-
                {% if button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_2_light_schedule, 'transition') | default(button_2_light_transition, true) | float }}
                  {% else %}
                    {{ button_2_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_2_on
          - alias: Light Mode
            if:
              - "{{ button_2_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_2_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_2_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_2_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                  transition: "{{ button_2_transition }}"
                                target: "{{ button_2_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_2_transition }}"
                            target: "{{ button_2_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_2_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_2_transition }}"
                        target: "{{ button_2_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_2_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_2_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_2_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                  transition: "{{ button_2_transition }}"
                                target: "{{ button_2_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_2_transition }}"
                            target: "{{ button_2_light }}"
      # ========== BUTTON 2 OFF ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 2 and trigger.event.data.command == 'off' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action in ['off_right', 'off_bottom_left'] }}"
        alias: "Button 2 off"
        sequence:
          - alias: "Set button 2 configuration variables"
            variables:
              button_2_has_light: >-
                {{ button_2_light.entity_id | default([]) | length > 0
                or button_2_light.device_id | default([]) | length > 0
                or button_2_light.area_id | default([]) | length > 0 }}
              button_2_light_adjustment_mode: !input button_2_light_adjustment_mode
              button_2_light_adaptive_brightness: !input button_2_light_adaptive_brightness
              button_2_light_brightness: !input button_2_light_brightness
              button_2_light_schedule: !input button_2_light_schedule
              button_2_light_adaptive_color_temp: !input button_2_light_adaptive_color_temp
              button_2_light_color: !input button_2_light_color
              button_2_light_transition: !input button_2_light_transition
              button_2_off_light_mode: !input button_2_off_light_mode
              button_2_off_reset_to_defaults: !input button_2_off_reset_to_defaults
              button_2_color_temp_kelvin: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_color_temp) | int(button_2_light_color) }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_2_light_color }}
                  {% else %}
                    {{ button_2_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_color }}
                {% endif %}
              button_2_brightness_pct: >-
                {% if button_2_light_adjustment_mode == 'adaptive' %}
                  {% if button_2_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_2_light_adaptive_brightness) | int(button_2_light_brightness) }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% elif button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_2_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_2_light_brightness }}
                  {% else %}
                    {{ button_2_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_brightness }}
                {% endif %}
              button_2_transition: >-
                {% if button_2_light_adjustment_mode == 'schedule' %}
                  {% if button_2_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_2_light_schedule, 'transition') | default(button_2_light_transition, true) | float }}
                  {% else %}
                    {{ button_2_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_2_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_2_off
          - alias: Light Mode
            if:
              - "{{ button_2_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_2_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_2_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_2_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                  transition: "{{ button_2_transition }}"
                                target: "{{ button_2_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_2_transition }}"
                            target: "{{ button_2_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_2_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_2_transition }}"
                        target: "{{ button_2_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_2_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_2_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_2_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_2_color_temp_kelvin }}"
                                  transition: "{{ button_2_transition }}"
                                target: "{{ button_2_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_2_transition }}"
                            target: "{{ button_2_light }}"
      # ========== BUTTON 3 ON ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 3 and trigger.event.data.command == 'on' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'on_top_right' }}"
        alias: "Button 3 on"
        sequence:
          - alias: "Set button 3 configuration variables"
            variables:
              button_3_has_light: >-
                {{ button_3_light.entity_id | default([]) | length > 0
                or button_3_light.device_id | default([]) | length > 0
                or button_3_light.area_id | default([]) | length > 0 }}
              button_3_light_adjustment_mode: !input button_3_light_adjustment_mode
              button_3_light_adaptive_brightness: !input button_3_light_adaptive_brightness
              button_3_light_brightness: !input button_3_light_brightness
              button_3_light_schedule: !input button_3_light_schedule
              button_3_light_adaptive_color_temp: !input button_3_light_adaptive_color_temp
              button_3_light_color: !input button_3_light_color
              button_3_light_transition: !input button_3_light_transition
              button_3_on_light_mode: !input button_3_on_light_mode
              button_3_on_reset_to_defaults: !input button_3_on_reset_to_defaults
              button_3_color_temp_kelvin: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_color_temp) | int(button_3_light_color) }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_3_light_color }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_color }}
                {% endif %}
              button_3_brightness_pct: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_brightness) | int(button_3_light_brightness) }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_3_light_brightness }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_brightness }}
                {% endif %}
              button_3_transition: >-
                {% if button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_3_light_schedule, 'transition') | default(button_3_light_transition, true) | float }}
                  {% else %}
                    {{ button_3_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_3_on
          - alias: Light Mode
            if:
              - "{{ button_3_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_3_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_3_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_3_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                  transition: "{{ button_3_transition }}"
                                target: "{{ button_3_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_3_transition }}"
                            target: "{{ button_3_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_3_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_3_transition }}"
                        target: "{{ button_3_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_3_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_3_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_3_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                  transition: "{{ button_3_transition }}"
                                target: "{{ button_3_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_3_transition }}"
                            target: "{{ button_3_light }}"
      # ========== BUTTON 3 OFF ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 3 and trigger.event.data.command == 'off' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'off_top_right' }}"
        alias: "Button 3 off"
        sequence:
          - alias: "Set button 3 configuration variables"
            variables:
              button_3_has_light: >-
                {{ button_3_light.entity_id | default([]) | length > 0
                or button_3_light.device_id | default([]) | length > 0
                or button_3_light.area_id | default([]) | length > 0 }}
              button_3_light_adjustment_mode: !input button_3_light_adjustment_mode
              button_3_light_adaptive_brightness: !input button_3_light_adaptive_brightness
              button_3_light_brightness: !input button_3_light_brightness
              button_3_light_schedule: !input button_3_light_schedule
              button_3_light_adaptive_color_temp: !input button_3_light_adaptive_color_temp
              button_3_light_color: !input button_3_light_color
              button_3_light_transition: !input button_3_light_transition
              button_3_off_light_mode: !input button_3_off_light_mode
              button_3_off_reset_to_defaults: !input button_3_off_reset_to_defaults
              button_3_color_temp_kelvin: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_color_temp) | int(button_3_light_color) }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_3_light_color }}
                  {% else %}
                    {{ button_3_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_color }}
                {% endif %}
              button_3_brightness_pct: >-
                {% if button_3_light_adjustment_mode == 'adaptive' %}
                  {% if button_3_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_3_light_adaptive_brightness) | int(button_3_light_brightness) }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% elif button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_3_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_3_light_brightness }}
                  {% else %}
                    {{ button_3_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_brightness }}
                {% endif %}
              button_3_transition: >-
                {% if button_3_light_adjustment_mode == 'schedule' %}
                  {% if button_3_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_3_light_schedule, 'transition') | default(button_3_light_transition, true) | float }}
                  {% else %}
                    {{ button_3_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_3_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_3_off
          - alias: Light Mode
            if:
              - "{{ button_3_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_3_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_3_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_3_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                  transition: "{{ button_3_transition }}"
                                target: "{{ button_3_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_3_transition }}"
                            target: "{{ button_3_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_3_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_3_transition }}"
                        target: "{{ button_3_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_3_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_3_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_3_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_3_color_temp_kelvin }}"
                                  transition: "{{ button_3_transition }}"
                                target: "{{ button_3_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_3_transition }}"
                            target: "{{ button_3_light }}"
      # ========== BUTTON 4 ON ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 4 and trigger.event.data.command == 'on' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'on_bottom_right' }}"
        alias: "Button 4 on"
        sequence:
          - alias: "Set button 4 configuration variables"
            variables:
              button_4_has_light: >-
                {{ button_4_light.entity_id | default([]) | length > 0
                or button_4_light.device_id | default([]) | length > 0
                or button_4_light.area_id | default([]) | length > 0 }}
              button_4_light_adjustment_mode: !input button_4_light_adjustment_mode
              button_4_light_adaptive_brightness: !input button_4_light_adaptive_brightness
              button_4_light_brightness: !input button_4_light_brightness
              button_4_light_schedule: !input button_4_light_schedule
              button_4_light_adaptive_color_temp: !input button_4_light_adaptive_color_temp
              button_4_light_color: !input button_4_light_color
              button_4_light_transition: !input button_4_light_transition
              button_4_on_light_mode: !input button_4_on_light_mode
              button_4_on_reset_to_defaults: !input button_4_on_reset_to_defaults
              button_4_color_temp_kelvin: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_color_temp) | int(button_4_light_color) }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_4_light_color }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_color }}
                {% endif %}
              button_4_brightness_pct: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_brightness) | int(button_4_light_brightness) }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_4_light_brightness }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_brightness }}
                {% endif %}
              button_4_transition: >-
                {% if button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_4_light_schedule, 'transition') | default(button_4_light_transition, true) | float }}
                  {% else %}
                    {{ button_4_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_4_on
          - alias: Light Mode
            if:
              - "{{ button_4_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_4_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_4_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_4_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                  transition: "{{ button_4_transition }}"
                                target: "{{ button_4_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_4_transition }}"
                            target: "{{ button_4_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_4_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_4_transition }}"
                        target: "{{ button_4_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_4_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_4_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_4_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                  transition: "{{ button_4_transition }}"
                                target: "{{ button_4_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_4_transition }}"
                            target: "{{ button_4_light }}"
      # ========== BUTTON 4 OFF ==========
      - conditions:
          - or:
              - "{{ trigger.id == 'zha_button' and trigger.event.data.endpoint_id == 4 and trigger.event.data.command == 'off' }}"
              - "{{ trigger.id == 'z2m_button' and trigger.payload_json.action == 'off_bottom_right' }}"
        alias: "Button 4 off"
        sequence:
          - alias: "Set button 4 configuration variables"
            variables:
              button_4_has_light: >-
                {{ button_4_light.entity_id | default([]) | length > 0
                or button_4_light.device_id | default([]) | length > 0
                or button_4_light.area_id | default([]) | length > 0 }}
              button_4_light_adjustment_mode: !input button_4_light_adjustment_mode
              button_4_light_adaptive_brightness: !input button_4_light_adaptive_brightness
              button_4_light_brightness: !input button_4_light_brightness
              button_4_light_schedule: !input button_4_light_schedule
              button_4_light_adaptive_color_temp: !input button_4_light_adaptive_color_temp
              button_4_light_color: !input button_4_light_color
              button_4_light_transition: !input button_4_light_transition
              button_4_off_light_mode: !input button_4_off_light_mode
              button_4_off_reset_to_defaults: !input button_4_off_reset_to_defaults
              button_4_color_temp_kelvin: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_color_temp not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_color_temp) | int(button_4_light_color) }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'color_temp_kelvin') %}
                    {{ val if val is not none else button_4_light_color }}
                  {% else %}
                    {{ button_4_light_color }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_color }}
                {% endif %}
              button_4_brightness_pct: >-
                {% if button_4_light_adjustment_mode == 'adaptive' %}
                  {% if button_4_light_adaptive_brightness not in [none, '', []] %}
                    {{ states(button_4_light_adaptive_brightness) | int(button_4_light_brightness) }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% elif button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {% set val = state_attr(button_4_light_schedule, 'brightness_pct') %}
                    {{ val if val is not none else button_4_light_brightness }}
                  {% else %}
                    {{ button_4_light_brightness }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_brightness }}
                {% endif %}
              button_4_transition: >-
                {% if button_4_light_adjustment_mode == 'schedule' %}
                  {% if button_4_light_schedule not in [none, '', null, []] %}
                    {{ state_attr(button_4_light_schedule, 'transition') | default(button_4_light_transition, true) | float }}
                  {% else %}
                    {{ button_4_light_transition | float }}
                  {% endif %}
                {% else %}
                  {{ button_4_light_transition | float }}
                {% endif %}
          - alias: Custom Action
            sequence: !input button_4_off
          - alias: Light Mode
            if:
              - "{{ button_4_has_light }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_4_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_4_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_4_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                  transition: "{{ button_4_transition }}"
                                target: "{{ button_4_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_4_transition }}"
                            target: "{{ button_4_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_4_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_4_transition }}"
                        target: "{{ button_4_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_4_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_4_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_4_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_4_color_temp_kelvin }}"
                                  transition: "{{ button_4_transition }}"
                                target: "{{ button_4_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_4_transition }}"
                            target: "{{ button_4_light }}"
