blueprint:
  name: Niko Battery Switch with 1 Button (Z2M / ZHA)
  author: danielpetrovic
  source_url: https://github.com/danielpetrovic/home-assistant-config/blob/main/blueprints/automation/danielpetrovic/niko-battery-switch-with-1-button.yaml
  description: |
    # Niko Battery Switch with 1 Button (Z2M / ZHA)

    This blueprint enables comprehensive control of a Niko Battery switch (model 552-720X1) through Zigbee2MQTT or ZHA integration, supporting both custom actions and light automation.

    ## Key Features
    - **Multiple Integration Options**: Choose Zigbee2MQTT (Z2M), ZHA, or both
    - **Custom Mode:** Program the button to execute your personalized home automation routines, from controlling your shades to activating security modes.
    - **Lights Mode:** Dim, brighten, and change the color of your lights depending on day and time of day with the intuitive button and a schedule.
    - **Auto-Adjust:** Optionally enable automatic light adjustment when your schedule changes - lights will smoothly transition to match the current schedule settings.

    *Each configuration option below includes detailed instructions in the automation editor.*

    ## Button Functions
    - **Short Press On/Off:** The button alternates between On and Off commands
    - **Long Press:** Built-in dimming functionality (increase/decrease brightness)
    - **Double Press:** Custom command (not built into the switch, implemented by blueprint)

    ## Schedule Helper Configuration

    Create time-based brightness and color adjustments using Home Assistant schedule helpers.

    ### Setting up Packages (Optional)
    Organize schedules into packages for easier management. Create a `packages` folder in `/config/` and add to your configuration:

    ```yaml
    homeassistant:
      packages: !include_dir_named packages
    ```

    ### Schedule YAML Example
    Create `/config/packages/lights.yaml` with your schedules:

    ```yaml
    schedule:
      lights_bright:
        name: "Lights Bright"
        icon: mdi:lightbulb-auto
        monday:
          - from: "00:00:00"
            to: "09:00:00"
            data:
              brightness_pct: 30
              color_temp_kelvin: 3333
          - from: "09:00:00"
            to: "23:00:00"
            data:
              brightness_pct: 90
              color_temp_kelvin: 3333
          - from: "23:00:00"
            to: "24:00:00"
            data:
              brightness_pct: 30
              color_temp_kelvin: 3333
        # Repeat pattern for tuesday through sunday
    ```

    You can create multiple schedules with different brightness levels (e.g., `lights_bright` and `lights_dimmed`) for different scenarios.

    ## Schedule Flexibility

    **Optional Fields:** If a schedule lacks certain data fields (like `transition`), the blueprint reverts to default values configured in the automation. This allows selective override of specific parameters while maintaining other preset defaults.

    **Supported Schedule Attributes:**
    - `brightness_pct`: Brightness percentage (0-100)
    - `color_temp_kelvin`: Color temperature in Kelvin
    - `transition`: Optional transition time in seconds

    ## Auto-Adjust Feature

    When enabled, the blueprint automatically updates lights when the schedule changes (e.g., when moving from morning to afternoon time block):
    - Only affects lights that are currently ON
    - Configurable transition duration (default: 5 minutes)
    - Applies current schedule's brightness and color temperature
    - Can be enabled/disabled per automation

    ## Requirements
    - Home Assistant 2024.10.0 or later
    - Zigbee2MQTT (Z2M) and/or Zigbee Home Automation (ZHA)
    - Niko Battery switch model 552-720X1
  domain: automation
  homeassistant:
    min_version: 2024.10.0
  input:
    integration_type:
      name: Integration Type
      description: |
        `required`

        Select which integration(s) to use for the Niko switch. You can select Z2M, ZHA, or both.
      default: []
      selector:
        select:
          options:
            - label: Zigbee2MQTT (Z2M)
              value: z2m
            - label: Zigbee Home Automation (ZHA)
              value: zha
          multiple: true
    zha:
      name: Zigbee Home Automation (ZHA)
      description: Configure ZHA integration settings.
      icon: mdi:zigbee
      collapsed: true
      input:
        zha_remote:
          name: Remote Device (ZHA)
          description: |
            `optional` `device`

            Select the Niko switch device from ZHA. Leave empty if not using ZHA.
          default: {}
          selector:
            device:
              filter:
                - integration: zha
                  manufacturer: NIKO NV
                  model: Battery switch, 1 button
              multiple: false
    z2m:
      name: Zigbee2MQTT (Z2M)
      description: Configure Zigbee2MQTT integration settings.
      icon: mdi:zigbee
      collapsed: true
      input:
        z2m_base_topic:
          name: Base Topic
          description: |
            `optional` `text`

            MQTT base topic for Zigbee2MQTT installation. Default is `zigbee2mqtt`. Leave empty if not using Z2M.
          default: "zigbee2mqtt"
          selector:
            text: {}
        z2m_device_name:
          name: Device Friendly Name
          description: |
            `optional` `text`

            Friendly name of your Niko switch in Z2M (case-sensitive, as shown in Z2M UI). Leave empty if not using Z2M.
          default: ""
          selector:
            text: {}
    button_1_custom:
      name: Button 1 - Custom Actions
      icon: mdi:numeric-1-circle-outline
      collapsed: true
      input:
        button_1_on:
          name: Short Press On
          description: |
            `optional` `action`

            Action for short press in on state.
          default: []
          selector:
            action: {}
        button_1_off:
          name: Short Press Off
          description: |
            `optional` `action`

            Action for short press in off state.
          default: []
          selector:
            action: {}
        button_1_double_press:
          name: Double Press
          description: |
            `optional` `action`

            Action for double press detection.
          default: []
          selector:
            action: {}
        button_1_increase:
          name: Long Press Increase
          description: |
            `optional` `action`

            Action for long press from off state or when alternating brightness up.
          default: []
          selector:
            action: {}
        button_1_decrease:
          name: Long Press Decrease
          description: |
            `optional` `action`

            Action for long press from on state or when alternating brightness down.
          default: []
          selector:
            action: {}
        button_1_stop:
          name: Long Press Release
          description: |
            `optional` `action`

            Action for release after long press.
          default: []
          selector:
            action: {}
    button_1_light:
      name: Button 1 - Light Mode
      icon: mdi:lightbulb
      collapsed: true
      input:
        button_1_light:
          name: Lights
          default: []
          description: |
            `optional` `target`

            Select lights to control.
          selector:
            target:
              entity:
                - domain:
                    - light
        button_1_light_schedule:
          name: Schedule
          default: []
          description: |
            `optional` `schedule`

            Schedule helper for time-based brightness and color adjustments. **Schedules can be reused between lights.**
          selector:
            entity:
              filter:
                - domain:
                    - schedule
              multiple: false
        button_1_light_brightness:
          name: Default Brightness
          default: 100
          description: |
            `optional` `number`

            Default brightness percentage (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 100.0
              step: 5.0
              unit_of_measurement: "%"
              mode: slider
        button_1_light_color:
          name: Default Color Temperature
          default: 3333
          description: |
            `optional` `color_temp`

            Default color temperature in Kelvin (fallback when schedule is not set or lacks this attribute).
          selector:
            color_temp:
              unit: kelvin
              min: 2000
        button_1_light_transition:
          name: Default Transition
          default: 1
          description: |
            `optional` `number`

            Default transition duration in seconds (fallback when schedule is not set or lacks this attribute).
          selector:
            number:
              min: 0.0
              max: 10.0
              mode: slider
              step: 1.0
        button_1_light_dimming_speed:
          name: Dimming Speed
          default: 5
          description: |
            `optional` `number`

            Controls how fast lights dim (1=slowest/smoothest, 10=fastest/jumpiest).
          selector:
            number:
              min: 1.0
              max: 10.0
              step: 1.0
              mode: slider
        button_1_on_light_mode:
          name: Short Press On Actions
          default: turn_on
          description: |
            `optional` `select`

            Light actions for short press in on state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_on_reset_to_defaults:
          name: Reset to Schedule/Defaults on Short Press On
          default: true
          description: |
            `optional` `boolean`

            Apply schedule/default brightness and color when turning on. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_off_light_mode:
          name: Short Press Off Actions
          default: turn_off
          description: |
            `optional` `select`

            Light actions for short press in off state. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Turn On"
                  value: turn_on
                - label: "Turn Off"
                  value: turn_off
                - label: "Toggle"
                  value: toggle
              custom_value: false
              multiple: true
        button_1_off_reset_to_defaults:
          name: Reset to Schedule/Defaults on Short Press Off
          default: true
          description: |
            `optional` `boolean`

            Apply schedule/default brightness and color when turning off. Disable to maintain current light settings.
          selector:
            boolean:
        button_1_dimmer_light_mode:
          name: Long Press Actions
          default: dim
          description: |
            `optional` `select`

            Light actions for long press. Multiple selections trigger simultaneously.
          selector:
            select:
              options:
                - label: "Dim"
                  value: dim
              custom_value: false
              multiple: true
        button_1_dimmer_reset_to_defaults:
          name: Reset to Schedule/Defaults on Long Press
          default: false
          description: |
            `optional` `boolean`

            Apply schedule/default color temperature while dimming. Enable to reset color, disable for pure brightness adjustment.
          selector:
            boolean:
    button_1_auto_adjust:
      name: Button 1 - Auto-Adjust
      icon: mdi:auto-fix
      collapsed: true
      input:
        button_1_light_schedule_auto_adjust:
          name: Auto-Adjust on Schedule Change
          default: false
          description: |
            `optional` `boolean`

            Automatically update lights when schedule changes. Only affects currently on lights.
          selector:
            boolean:
        button_1_light_schedule_auto_adjust_transition:
          name: Auto-Adjust Transition
          default: 300
          description: |
            `optional` `number`

            Transition duration in seconds when auto-adjusting lights on schedule change.
          selector:
            number:
              min: 0.0
              max: 600.0
              mode: slider
              step: 30.0
              unit_of_measurement: "s"
mode: single
trigger_variables:
  integration_type: !input integration_type
  z2m_base_topic: !input z2m_base_topic
  z2m_device_name: !input z2m_device_name
variables:
  stop_flag: false
  integration_type: !input integration_type
  z2m_base_topic: !input z2m_base_topic
  z2m_device_name: !input z2m_device_name
  button_1_light: !input button_1_light
  has_light_target: >-
    {{ button_1_light.entity_id | default([]) | length > 0
    or button_1_light.device_id | default([]) | length > 0
    or button_1_light.area_id | default([]) | length > 0 }}
triggers:
  - trigger: event
    event_type: zha_event
    event_data:
      device_id: !input zha_remote
    alias: zha_button
    id: zha_button
  - trigger: mqtt
    topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
    alias: z2m_button
    id: z2m_button
  - trigger: state
    entity_id: !input button_1_light_schedule
    id: schedule_change
actions:
  - variables:
      button_1_light_schedule: !input button_1_light_schedule
      button_1_light_color: !input button_1_light_color
      button_1_light_brightness: !input button_1_light_brightness
      button_1_light_transition: !input button_1_light_transition
      button_1_light_dimming_speed: !input button_1_light_dimming_speed
      button_1_light_step_size: "{{ (button_1_light_dimming_speed * 2.5) | int }}"
      button_1_dimming_delay: "{{ [0.15, (0.5 / button_1_light_dimming_speed)] | max }}"
      button_1_light_count:
        "{% set calc = (255 / button_1_light_step_size) | abs |
        round(0, 'ceil') %} {{ [calc, 3] | max }}"
      button_1_on_light_mode: !input button_1_on_light_mode
      button_1_on_reset_to_defaults: !input button_1_on_reset_to_defaults
      button_1_off_light_mode: !input button_1_off_light_mode
      button_1_off_reset_to_defaults: !input button_1_off_reset_to_defaults
      button_1_dimmer_light_mode: !input button_1_dimmer_light_mode
      button_1_dimmer_reset_to_defaults: !input button_1_dimmer_reset_to_defaults
      button_1_color_temp_kelvin: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {% set val = state_attr(button_1_light_schedule, 'color_temp_kelvin') %}
          {{ val if val is not none else button_1_light_color }}
        {% else %}
          {{ button_1_light_color }}
        {% endif %}
      button_1_brightness_pct: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {% set val = state_attr(button_1_light_schedule, 'brightness_pct') %}
          {{ val if val is not none else button_1_light_brightness }}
        {% else %}
          {{ button_1_light_brightness }}
        {% endif %}
      button_1_transition: >-
        {% if button_1_light_schedule not in [none, '', null] %}
          {{ state_attr(button_1_light_schedule, 'transition') | default(button_1_light_transition, true) | float }}
        {% else %}
          {{ button_1_light_transition | float }}
        {% endif %}
      button_1_light_schedule_auto_adjust: !input button_1_light_schedule_auto_adjust
      button_1_light_schedule_auto_adjust_transition: !input button_1_light_schedule_auto_adjust_transition
      light_entities: >-
        {% set ns = namespace(entities=[]) %}
        {% if button_1_light.entity_id is defined and button_1_light.entity_id | length > 0 %}
          {% if button_1_light.entity_id is string %}
            {% set ns.entities = [button_1_light.entity_id] %}
          {% else %}
            {% set ns.entities = button_1_light.entity_id %}
          {% endif %}
        {% elif button_1_light.device_id is defined and button_1_light.device_id | length > 0 %}
          {% set devices = [button_1_light.device_id] if button_1_light.device_id is string else button_1_light.device_id %}
          {% for device in devices %}
            {% set ns.entities = ns.entities + device_entities(device) | select('match', '^light\.') | list %}
          {% endfor %}
        {% elif button_1_light.area_id is defined and button_1_light.area_id | length > 0 %}
          {% set areas = [button_1_light.area_id] if button_1_light.area_id is string else button_1_light.area_id %}
          {% for area in areas %}
            {% set ns.entities = ns.entities + area_entities(area) | select('match', '^light\.') | list %}
          {% endfor %}
        {% endif %}
        {{ ns.entities }}
      button_action: >-
        {% if trigger.id == 'zha_button' %}
          {% set cmd = trigger.event.data.command %}
          {% set args = trigger.event.data.args | default([]) %}
          {% if cmd == 'on' %}
            on
          {% elif cmd == 'off' %}
            off
          {% elif cmd in ['move', 'move_with_on_off'] and args[0] == 0 %}
            brightness_move_up
          {% elif cmd == 'move' and args[0] == 1 %}
            brightness_move_down
          {% elif cmd == 'stop' %}
            brightness_stop
          {% else %}
            unknown
          {% endif %}
        {% elif trigger.id == 'z2m_button' %}
          {{ trigger.payload_json.action | default('unknown') }}
        {% else %}
          none
        {% endif %}
      is_button_event: "{{ trigger.id in ['zha_button', 'z2m_button'] }}"
  - condition: >-
      {{ (trigger.id == 'zha_button' and 'zha' in integration_type) or
         (trigger.id == 'z2m_button' and 'z2m' in integration_type) or
         trigger.id == 'schedule_change' }}
  - choose:
      - conditions:
          - "{{ trigger.id == 'schedule_change' }}"
          - "{{ button_1_light_schedule_auto_adjust }}"
          - "{{ has_light_target }}"
          - "{{ button_1_light_schedule not in [none, '', null] }}"
        sequence:
          - repeat:
              for_each: "{{ light_entities }}"
              sequence:
                - if:
                    - "{{ is_state(repeat.item, 'on') }}"
                  then:
                    - action: light.turn_on
                      target:
                        entity_id: "{{ repeat.item }}"
                      data:
                        brightness_pct: "{{ button_1_brightness_pct }}"
                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                        transition: "{{ button_1_light_schedule_auto_adjust_transition }}"
          - stop: Schedule auto-adjust completed
      - conditions:
          - "{{ is_button_event }}"
          - "{{ button_action == 'brightness_move_up' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_increase
          - alias: Light Mode
            if:
              - "{{ 'dim' in button_1_dimmer_light_mode and has_light_target }}"
            then:
              - parallel:
                  - sequence:
                      - wait_for_trigger:
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: stop
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: "on"
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: "off"
                          - trigger: mqtt
                            topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                        timeout: "30"
                        continue_on_timeout: true
                      - variables:
                          stop_flag: true
                  - sequence:
                      - repeat:
                          count: "{{ button_1_light_count }}"
                          sequence:
                            - choose:
                                - conditions:
                                    - "{{ button_1_dimmer_reset_to_defaults }}"
                                  sequence:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ button_1_light_step_size }}"
                                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                              default:
                                - action: light.turn_on
                                  target: "{{ button_1_light }}"
                                  data:
                                    brightness_step: "{{ button_1_light_step_size }}"
                            - delay:
                                seconds: "{{ button_1_dimming_delay }}"
                            - if:
                                - "{{ stop_flag }}"
                              then:
                                - stop: Stop flag set
              - stop: Done increase brightness
      - conditions:
          - "{{ is_button_event }}"
          - "{{ button_action == 'brightness_move_down' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_decrease
          - alias: Light Mode
            if:
              - "{{ 'dim' in button_1_dimmer_light_mode and has_light_target }}"
            then:
              - parallel:
                  - sequence:
                      - wait_for_trigger:
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: stop
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: "on"
                          - trigger: event
                            event_type: zha_event
                            event_data:
                              device_id: !input zha_remote
                              command: "off"
                          - trigger: mqtt
                            topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
                        timeout: "30"
                        continue_on_timeout: true
                      - variables:
                          stop_flag: true
                  - sequence:
                      - repeat:
                          count: "{{ button_1_light_count }}"
                          sequence:
                            - choose:
                                - conditions:
                                    - "{{ button_1_dimmer_reset_to_defaults }}"
                                  sequence:
                                    - action: light.turn_on
                                      target: "{{ button_1_light }}"
                                      data:
                                        brightness_step: "{{ 0 - button_1_light_step_size }}"
                                        color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                              default:
                                - action: light.turn_on
                                  target: "{{ button_1_light }}"
                                  data:
                                    brightness_step: "{{ 0 - button_1_light_step_size }}"
                            - delay:
                                seconds: "{{ button_1_dimming_delay }}"
                            - if:
                                - "{{ stop_flag }}"
                              then:
                                - stop: Stop flag set
              - stop: Done decrease brightness
      - conditions:
          - "{{ is_button_event }}"
          - "{{ button_action == 'brightness_stop' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_stop
  - condition: "{{ is_button_event }}"
  - condition: "{{ button_action in ['on', 'off'] }}"
  - variables:
      first_action: "{{ button_action }}"
  - wait_for_trigger:
      - trigger: event
        event_type: zha_event
        event_data:
          device_id: !input zha_remote
      - trigger: mqtt
        topic: "{{ z2m_base_topic ~ '/' ~ z2m_device_name }}"
    timeout: "0.30"
    continue_on_timeout: true
  - variables:
      second_action: >-
        {% if wait.trigger is none %}
          none
        {% elif wait.trigger.platform == 'event' %}
          {{ wait.trigger.event.data.command }}
        {% elif wait.trigger.platform == 'mqtt' %}
          {{ wait.trigger.payload_json.action | default('none') }}
        {% else %}
          none
        {% endif %}
  - if:
      - "{{ second_action in ['on', 'off'] and second_action != first_action }}"
    then:
      - sequence: !input button_1_double_press
      - stop: Double Press detected
  - choose:
      - conditions:
          - "{{ first_action == 'on' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_on
          - alias: Light Mode
            if:
              - "{{ has_light_target }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_on_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_on_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_on_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
      - conditions:
          - "{{ first_action == 'off' }}"
        sequence:
          - alias: Custom Action
            sequence: !input button_1_off
          - alias: Light Mode
            if:
              - "{{ has_light_target }}"
            then:
              - parallel:
                  - alias: turn_on
                    if:
                      - "{{ 'turn_on' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.turn_on
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.turn_on
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
                  - alias: turn_off
                    if:
                      - "{{ 'turn_off' in button_1_off_light_mode }}"
                    then:
                      - action: light.turn_off
                        data:
                          transition: "{{ button_1_transition }}"
                        target: "{{ button_1_light }}"
                  - alias: toggle
                    if:
                      - "{{ 'toggle' in button_1_off_light_mode }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ button_1_off_reset_to_defaults }}"
                            sequence:
                              - action: light.toggle
                                data:
                                  brightness_pct: "{{ button_1_brightness_pct }}"
                                  color_temp_kelvin: "{{ button_1_color_temp_kelvin }}"
                                  transition: "{{ button_1_transition }}"
                                target: "{{ button_1_light }}"
                        default:
                          - action: light.toggle
                            data:
                              transition: "{{ button_1_transition }}"
                            target: "{{ button_1_light }}"
